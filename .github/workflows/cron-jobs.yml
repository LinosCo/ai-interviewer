# =============================================================================
# Cron Jobs Scheduler per AI Interviewer / Business Tuner
# =============================================================================
#
# Questo workflow sostituisce i Vercel Cron Jobs dato che la piattaforma
# Ã¨ deployata su Railway Hobby.
#
# Secrets necessari (configurare in GitHub > Settings > Secrets):
#   - CRON_SECRET:      Token segreto per autenticare le chiamate cron
#   - RAILWAY_APP_URL:  URL base dell'app Railway (es. https://myapp.up.railway.app)
#
# Tutti gli orari sono in UTC.
# =============================================================================

name: Cron Jobs

on:
  schedule:
    # â”€â”€ Daily Jobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - cron: '0 0 * * *'    # Ogni giorno a mezzanotte UTC
    - cron: '0 2 * * *'    # Ogni giorno alle 02:00 UTC
    - cron: '0 3 * * *'    # Ogni giorno alle 03:00 UTC

    # â”€â”€ Weekly Jobs (Domenica) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - cron: '0 4 * * 0'    # Domenica alle 04:00 UTC

    # â”€â”€ Weekly Jobs (Lunedi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - cron: '0 4 * * 1'    # Lunedi alle 04:00 UTC
    - cron: '0 6 * * 1'    # Lunedi alle 06:00 UTC
    - cron: '0 8 * * 1'    # Lunedi alle 08:00 UTC

    # â”€â”€ Monthly Jobs (1Â° del mese) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - cron: '30 0 1 * *'   # 1Â° del mese alle 00:30 UTC
    - cron: '0 1 1 * *'    # 1Â° del mese alle 01:00 UTC

  # Permette trigger manuale da GitHub UI
  workflow_dispatch:
    inputs:
      job:
        description: 'Quale cron job eseguire manualmente'
        required: true
        type: choice
        options:
          - all
          - reset-credits
          - aggregate-chatbot-analytics
          - cms-sync-analytics
          - detect-gaps
          - sync-insights
          - cms-generate-suggestions
          - serp-monitoring
          - reset-monthly-counters
          - partner-fees

env:
  APP_URL: ${{ secrets.RAILWAY_APP_URL }}
  AUTH_HEADER: 'Authorization: Bearer ${{ secrets.CRON_SECRET }}'
  CURL_OPTS: '--fail --silent --show-error --max-time 120 --retry 3 --retry-delay 10'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DAILY: Reset Credits (00:00 UTC)
  # Resetta monthlyCreditsUsed per org con creditsResetDate scaduta.
  # Design smart-daily: gira ogni giorno ma resetta solo le org "scadute".
  # CRITICO: senza questo, gli utenti non possono usare la piattaforma.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  reset-credits:
    if: >-
      github.event.schedule == '0 0 * * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'reset-credits' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Reset Credits
        run: |
          echo "ðŸ”„ Avvio reset crediti..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -X POST \
            -H "${{ env.AUTH_HEADER }}" \
            -H "Content-Type: application/json" \
            "${{ env.APP_URL }}/api/cron/reset-credits")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DAILY: Aggregate Chatbot Analytics (02:00 UTC)
  # Usa LLM per clusterizzare messaggi chatbot in temi e sentiment.
  # Alimenta la dashboard analytics chatbot.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  aggregate-chatbot-analytics:
    if: >-
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'aggregate-chatbot-analytics' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Aggregate Chatbot Analytics
        run: |
          echo "ðŸ“Š Avvio aggregazione analytics chatbot..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/aggregate-chatbot-analytics")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DAILY: CMS Sync Analytics (03:00 UTC)
  # Sincronizza dati da Google Analytics + Search Console.
  # Deve girare PRIMA di sync-insights per fornire dati freschi.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cms-sync-analytics:
    if: >-
      github.event.schedule == '0 3 * * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'cms-sync-analytics' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: CMS Sync Analytics
        run: |
          echo "ðŸ“ˆ Avvio sync analytics CMS..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/cms-sync-analytics")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WEEKLY DOMENICA: Detect Knowledge Gaps (04:00 UTC)
  # Per ogni bot PUBLISHED, analizza conversazioni per gap nella KB.
  # Meccanismo di auto-growth della knowledge base.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-gaps:
    if: >-
      github.event.schedule == '0 4 * * 0' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'detect-gaps' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Detect Knowledge Gaps
        run: |
          echo "ðŸ” Avvio rilevamento gap nella knowledge base..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/detect-gaps")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WEEKLY LUNEDI: Cross-Channel Sync Insights (04:00 UTC)
  # Aggrega 6 fonti dati â†’ LLM genera 5-7 insight azionabili per org.
  # Alimenta CMS suggestions e dashboard insight.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sync-insights:
    if: >-
      github.event.schedule == '0 4 * * 1' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'sync-insights' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Sync Cross-Channel Insights
        run: |
          echo "ðŸ”— Avvio sync insight cross-channel..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/sync-insights")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WEEKLY LUNEDI: CMS Generate Suggestions (06:00 UTC)
  # Genera suggerimenti contenuto da CrossChannelInsight recenti.
  # Gira 2h dopo sync-insights per avere insight freschi.
  # Ridotto da daily a weekly: gli insight arrivano solo il lunedi.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cms-generate-suggestions:
    if: >-
      github.event.schedule == '0 6 * * 1' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'cms-generate-suggestions' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Generate CMS Suggestions
        run: |
          echo "ðŸ’¡ Avvio generazione suggerimenti CMS..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/cms-generate-suggestions")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WEEKLY LUNEDI: SERP Monitoring (08:00 UTC)
  # Scan Google per menzioni brand via SerpAPI.
  # Rate limited: 2s delay tra scan. Settimanale per limiti API.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  serp-monitoring:
    if: >-
      github.event.schedule == '0 8 * * 1' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'serp-monitoring' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: SERP Monitoring Scan
        run: |
          echo "ðŸ”Ž Avvio SERP monitoring..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -H "${{ env.AUTH_HEADER }}" \
            "${{ env.APP_URL }}/api/cron/serp-monitoring")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MONTHLY: Reset Monthly Counters (1Â° del mese, 00:30 UTC)
  # Resetta responsesUsedThisMonth e riattiva bot PAUSED.
  # Gira 30min dopo reset-credits per evitare conflitti DB.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  reset-monthly-counters:
    if: >-
      github.event.schedule == '30 0 1 * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'reset-monthly-counters' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Reset Monthly Counters
        run: |
          echo "ðŸ”„ Avvio reset contatori mensili..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -X POST \
            -H "${{ env.AUTH_HEADER }}" \
            -H "Content-Type: application/json" \
            "${{ env.APP_URL }}/api/cron/reset-monthly-counters")
          echo "Response: $RESPONSE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MONTHLY: Partner Fees (1Â° del mese, 01:00 UTC)
  # Calcola fee partner, gestisce trial expiry e grace period.
  # Gira dopo reset-monthly-counters per avere contatori freschi.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  partner-fees:
    if: >-
      github.event.schedule == '0 1 1 * *' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'partner-fees' || github.event.inputs.job == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Calculate Partner Fees
        run: |
          echo "ðŸ’° Avvio calcolo fee partner..."
          RESPONSE=$(curl ${{ env.CURL_OPTS }} \
            -X POST \
            -H "${{ env.AUTH_HEADER }}" \
            -H "Content-Type: application/json" \
            "${{ env.APP_URL }}/api/cron/partner-fees")
          echo "Response: $RESPONSE"
