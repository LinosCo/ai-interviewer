generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String    @id @default(cuid())
  name                    String?
  email                   String    @unique
  emailVerified           DateTime?
  password                String?
  image                   String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  platformOpenaiApiKey    String?
  platformAnthropicApiKey String?
  role                    UserRole  @default(USER)
  customApiKeys           Json?

  // Partner (resta a livello utente come "certificazione")
  isPartner               Boolean   @default(false)
  partnerStatus           String? // trial, active, suspended
  partnerTrialEndDate     DateTime?
  partnerFee              Int?
  partnerActiveClients    Int       @default(0)
  partnerWhiteLabel       Boolean   @default(false)
  partnerGracePeriodStart DateTime?
  partnerCustomLogo       String?

  // DEPRECATI - da rimuovere dopo migrazione
  plan                 UserPlanType @default(FREE)
  monthlyCreditsLimit  BigInt       @default(500000)
  monthlyCreditsUsed   BigInt       @default(0)
  creditsResetDate     DateTime?
  packCreditsAvailable BigInt       @default(0)

  accounts            Account[]
  copilotSessions     CopilotSession[]
  creditPacks         CreditPack[]
  creditTransactions  CreditTransaction[]
  memberships         Membership[]
  passwordResetTokens PasswordResetToken[]
  ownedProjects       Project[]
  projectAccess       ProjectAccess[]
  reports             Report[]
  rewardGrants        RewardGrant[]
  sessions            Session[]
  sentTransfers       ItemTransferInvite[] @relation("UserSentTransfers")

  // Relazioni attribuzione partner
  partnerAttributions PartnerClientAttribution[] @relation("PartnerAttributions")
  clientAttribution   PartnerClientAttribution?  @relation("ClientAttribution")
}

model ProjectAccess {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime    @default(now())
  role      ProjectRole @default(MEMBER)
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PlatformSettings {
  id                   String        @id @default(cuid())
  organizationId       String?       @unique // Collegato a Organization
  methodologyKnowledge String        @db.Text
  strategicPlan        String?       @db.Text // Piano strategico per il Copilot
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  organization         Organization? @relation
}

model GlobalConfig {
  id                       String   @id @default("default")
  openaiApiKey             String?
  anthropicApiKey          String?
  stripeSecretKey          String?
  stripeWebhookSecret      String?
  stripePriceStarter       String?
  stripePricePro           String?
  stripePriceBusiness      String?
  updatedAt                DateTime @updatedAt
  stripePriceProYearly     String?
  stripePriceStarterYearly String?
  geminiApiKey             String?
  googleSerpApiKey         String?
}

model Organization {
  id                     String   @id @default(cuid())
  name                   String
  slug                   String   @unique
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  allowCustomApiKeys     Boolean  @default(false)
  customLimits           Json?
  responsesUsedThisMonth Int      @default(0)
  monthlyResetDate       DateTime @default(now())
  address                String?
  city                   String?
  country                String   @default("IT")
  postalCode             String?
  vatId                  String?
  strategicVision        String?
  valueProposition       String?

  // Piano e billing (NUOVI - migrati da User/Subscription)
  plan         PlanType     @default(FREE)
  billingCycle BillingCycle @default(MONTHLY)

  // Crediti (NUOVI - migrati da User)
  monthlyCreditsLimit  BigInt    @default(500000)
  monthlyCreditsUsed   BigInt    @default(0)
  creditsResetDate     DateTime?
  packCreditsAvailable BigInt    @default(0) // crediti extra acquistati

  // Limiti membri
  maxMembers         Int @default(1) // dipende dal piano
  extraMemberSlots   Int @default(0)
  currentMemberCount Int @default(0)

  // Stripe
  stripeCustomerId String?       @unique
  subscription     Subscription?

  // Impostazioni della piattaforma (NUOVO - collegato a Organization)
  platformSettingsId   String?           @unique
  platformSettings     PlatformSettings? @relation(fields: [platformSettingsId], references: [id])
  stripeSubscriptionId String?
  subscriptionStatus   String? // ACTIVE, PAST_DUE, etc.
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean           @default(false)

  copilotSessions      CopilotSession[]
  crossChannelInsights CrossChannelInsight[]
  members              Membership[]
  projects             Project[]
  tokenLogs            TokenLog[]
  tokenUsage           TokenUsage?
  usageLogs            UsageLog[]
  visibilityConfigs    VisibilityConfig[]
  creditPacks          OrgCreditPack[]
  creditTransactions   OrgCreditTransaction[]
  invoices             OrgInvoice[]
  cmsConnections       CMSConnection[]
}

model Subscription {
  id                             String             @id @default(cuid())
  organizationId                 String             @unique
  tier                           SubscriptionTier   @default(TRIAL)
  status                         SubscriptionStatus @default(TRIALING)
  stripeCustomerId               String?            @unique
  stripeSubscriptionId           String?            @unique
  stripePriceId                  String?
  currentPeriodStart             DateTime           @default(now())
  currentPeriodEnd               DateTime?
  interviewsUsedThisMonth        Int                @default(0)
  billingEmail                   String?
  billingName                    String?
  vatNumber                      String?
  createdAt                      DateTime           @default(now())
  updatedAt                      DateTime           @updatedAt
  canceledAt                     DateTime?
  codiceFiscale                  String?
  pecEmail                       String?
  sdiCode                        String?
  customLimits                   Json?
  aiSuggestionsUsedThisMonth     Int                @default(0)
  chatbotSessionsUsedThisMonth   Int                @default(0)
  extraChatbotSessions           Int                @default(0)
  extraInterviews                Int                @default(0)
  extraUsers                     Int                @default(0)
  extraVisibilityQueries         Int                @default(0)
  isPartner                      Boolean            @default(false)
  tokensUsedThisMonth            Int                @default(0)
  trialEndsAt                    DateTime?
  visibilityQueriesUsedThisMonth Int                @default(0)
  billingAddress                 Json?
  cancelAtPeriodEnd              Boolean            @default(false)
  chatbotTokensUsed              Int                @default(0)
  extraAiSuggestions             Int                @default(0)
  extraTokens                    Int                @default(0)
  interviewTokensUsed            Int                @default(0)
  suggestionTokensUsed           Int                @default(0)
  systemTokensUsed               Int                @default(0)
  visibilityTokensUsed           Int                @default(0)
  invoices                       Invoice[]
  purchasedAddOns                PurchasedAddOn[]
  organization                   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Invoice {
  id              String       @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String       @unique
  amountPaid      Int
  currency        String       @default("eur")
  status          String
  pdfUrl          String?
  createdAt       DateTime     @default(now())
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])
}

model UsageEvent {
  id             String         @id @default(cuid())
  organizationId String
  eventType      UsageEventType
  resourceId     String?
  metadata       Json?
  createdAt      DateTime       @default(now())

  @@index([organizationId, createdAt])
}

model Membership {
  id             String @id @default(cuid())
  userId         String
  organizationId String
  role           Role   @default(MEMBER)

  // Stato membro
  status     MemberStatus @default(ACTIVE) // ACTIVE, INVITED, SUSPENDED
  invitedAt  DateTime?
  joinedAt   DateTime?
  invitedBy  String? // userId di chi ha invitato
  acceptedAt DateTime?

  // Notifiche e preferenze
  receiveAlerts Boolean @default(true) // riceve alert crediti esauriti etc

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([userId, organizationId])
}

enum MemberStatus {
  ACTIVE
  INVITED // Invitato ma non ha ancora accettato
  SUSPENDED // Sospeso temporaneamente
}

enum ItemTransferType {
  ORGANIZATION
  PROJECT
  BOT
  TOOL
}

enum TransferStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Project {
  id               String   @id @default(cuid())
  name             String
  organizationId   String?
  ownerId          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isPersonal       Boolean  @default(false)
  strategicVision  String?
  valueProposition String?

  // Partner tracking (per trasferimenti)
  originPartnerId      String? // partner che ha creato il progetto
  transferredAt        DateTime?
  transferredFromOrgId String? // org di origine se trasferito
  transferredToUserId  String?

  bots                 Bot[]
  cmsConnection        CMSConnection?
  mcpConnections       MCPConnection[]
  googleConnection     GoogleConnection?
  copilotSessions      CopilotSession[]
  creditTransactions   CreditTransaction[]
  crossChannelInsights CrossChannelInsight[]
  organization         Organization?         @relation(fields: [organizationId], references: [id])
  owner                User?                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  accessList           ProjectAccess[]
  projectTransfersFrom ProjectTransfer[]     @relation("OriginalProject")
  projectTransfersTo   ProjectTransfer[]     @relation("DuplicatedProject")
  visibilityConfigs    VisibilityConfig[]

  // Relazione attribuzione partner
  itemTransfers     ItemTransferInvite[]       @relation("ProjectItemTransfers")
  firstAttributions PartnerClientAttribution[] @relation("FirstAttributionProject")
}

// Transazioni crediti a livello organizzazione
model OrgCreditTransaction {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String?
  executedById   String? // utente che ha eseguito l'azione

  amount       BigInt // crediti consumati (positivo) o aggiunti (negativo)
  balanceAfter BigInt // saldo dopo transazione

  type        String // usage, monthly_reset, pack_purchase, adjustment, transfer
  tool        String? // interview, chatbot, visibility, copilot, tips, export
  action      String? // azione specifica
  description String?
  metadata    Json?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([projectId])
  @@index([type])
}

// Pack crediti acquistati dall'organizzazione
model OrgCreditPack {
  id             String @id @default(cuid())
  organizationId String

  packType         String // small, medium, large
  creditsPurchased BigInt
  creditsRemaining BigInt
  pricePaid        Decimal @db.Decimal(10, 2)

  stripePaymentId String?
  purchasedAt     DateTime @default(now())
  purchasedBy     String? // userId

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Fatture organizzazione (mirror di Stripe per consultazione rapida)
model OrgInvoice {
  id              String @id @default(cuid())
  organizationId  String
  stripeInvoiceId String @unique

  amountPaid    Int // in centesimi
  currency      String  @default("eur")
  status        String // paid, open, void, uncollectible
  invoiceNumber String?
  pdfUrl        String?
  hostedUrl     String? // link Stripe per visualizzare

  periodStart DateTime?
  periodEnd   DateTime?

  // Dettagli per fatturazione italiana
  vatNumber      String?
  companyName    String?
  billingAddress Json?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeInvoiceId])
}

model ProjectTransfer {
  id String @id @default(cuid())

  // Progetto originale (del partner)
  originalProjectId String
  originalOrgId     String

  // Progetto duplicato (del cliente)
  duplicatedProjectId String
  targetOrgId         String

  // Attori
  partnerId    String // Partner che trasferisce
  clientUserId String // Utente cliente che riceve

  // Opzioni
  partnerKeepsAccess Boolean @default(true) // Partner rimane VIEWER?
  includeData        Boolean @default(false) // Include risposte/analytics?

  transferredAt DateTime @default(now())

  // Relazioni
  originalProject   Project @relation("OriginalProject", fields: [originalProjectId], references: [id])
  duplicatedProject Project @relation("DuplicatedProject", fields: [duplicatedProjectId], references: [id])

  @@index([partnerId])
  @@index([clientUserId])
}

model ProjectTransferInvite {
  id        String @id @default(cuid())
  projectId String // Progetto da trasferire
  partnerId String // Partner che invita

  clientEmail String // Email destinatario
  token       String @unique

  // Opzioni trasferimento
  partnerKeepsAccess Boolean @default(true)
  includeData        Boolean @default(false)
  personalMessage    String?

  status     String    @default("pending") // pending, accepted, expired, revoked
  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([partnerId])
  @@index([clientEmail])
}

model OrganizationInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           Role      @default(MEMBER)
  token          String    @unique
  invitedById    String
  message        String?
  status         String    @default("PENDING") // PENDING, ACCEPTED, EXPIRED, REVOKED
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt DateTime @default(now())

  @@unique([organizationId, email])
}

model Bot {
  id                    String               @id @default(cuid())
  projectId             String
  slug                  String               @unique
  name                  String
  description           String?
  status                BotStatus            @default(DRAFT)
  researchGoal          String?
  targetAudience        String?
  language              String               @default("en")
  tone                  String?
  introMessage          String?
  maxDurationMins       Int                  @default(10)
  maxTurns              Int                  @default(20)
  maxOpenQuestions      Int                  @default(5)
  modelProvider         String               @default("openai")
  modelName             String               @default("gpt-4o")
  openaiApiKey          String?
  anthropicApiKey       String?
  logoUrl               String?
  primaryColor          String               @default("#6366f1")
  backgroundColor       String               @default("#ffffff")
  textColor             String               @default("#1f2937")
  anonymizationLevel    String               @default("partial")
  privacyNotice         String?
  dataUsageInfo         String?
  consentText           String?
  showAnonymityInfo     Boolean              @default(true)
  showDataUsageInfo     Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  analyticsMetadata     Json?
  formatExplanation     String?
  progressBarStyle      String               @default("semantic")
  showProgressBar       Boolean              @default(true)
  showTopicPreview      Boolean              @default(false)
  welcomeSubtitle       String?
  welcomeTitle          String?
  warmupChoices         Json?
  warmupContextPrompt   String?
  warmupFollowup        Boolean              @default(true)
  warmupIcebreaker      String?
  warmupStyle           String               @default("open")
  useWarmup             Boolean              @default(true)
  landingDescription    String?
  landingImageUrl       String?
  landingTitle          String?
  landingVideoUrl       String?
  candidateDataFields   Json?
  collectCandidateData  Boolean              @default(false)
  allowedDomains        Json?
  botType               String               @default("interview")
  bubbleAnimation       String               @default("bounce")
  bubbleIcon            String?
  bubblePosition        String               @default("bottom-right")
  bubbleSize            String               @default("medium")
  enablePageContext     Boolean              @default(true)
  fallbackMessage       String?
  leadCaptureMessage    String?
  leadCaptureStrategy   String               @default("after_3_msgs")
  maxMessagesPerSession Int                  @default(20)
  maxTokensPerMessage   Int                  @default(500)
  webhookUrl            String?
  privacyPolicyUrl      String?
  boundaries            Json?
  project               Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics             ChatbotAnalytics[]
  chatbotSessions       ChatbotSession[]
  conversations         Conversation[]
  faqSuggestions        FaqSuggestion[]
  hotIdeas              HotIdea[]
  insights              Insight[]
  knowledgeGaps         KnowledgeGap[]
  knowledgeSources      KnowledgeSource[]
  questionDefinitions   QuestionDefinition[]
  reports               Report[]
  rewardConfig          RewardConfig?
  themes                Theme[]
  topics                TopicBlock[]
}

model KnowledgeSource {
  id        String   @id @default(cuid())
  botId     String
  type      String
  title     String?
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model TopicBlock {
  id          String   @id @default(cuid())
  botId       String
  orderIndex  Int
  label       String
  description String?
  subGoals    String[]
  maxTurns    Int      @default(5)
  keywords    Json?
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, orderIndex])
}

model RewardConfig {
  id            String  @id @default(cuid())
  botId         String  @unique
  enabled       Boolean @default(false)
  type          String
  payload       String
  displayText   String?
  showOnLanding Boolean @default(true)
  bot           Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Conversation {
  id                String                @id @default(cuid())
  botId             String
  participantId     String
  status            String
  fatigueScore      Int                   @default(0)
  currentTopicId    String?
  startedAt         DateTime              @default(now())
  completedAt       DateTime?
  durationSeconds   Int?
  effectiveDuration Int                   @default(0)
  sentimentScore    Float?
  tags              String[]
  exchangeCount     Int                   @default(0)
  totalTokens       Int                   @default(0)
  metadata          Json?
  candidateProfile  Json?
  chatbotSession    ChatbotSession?
  bot               Bot                   @relation(fields: [botId], references: [id], onDelete: Cascade)
  analysis          ConversationAnalysis?
  memory            ConversationMemory?
  messages          Message[]
  rewardGrant       RewardGrant?
  answers           StructuredAnswer[]
  themeOccurrences  ThemeOccurrence[]

  @@index([botId])
  @@index([botId, status])
  @@index([botId, startedAt])
}

model ConversationMemory {
  id                String       @id @default(cuid())
  conversationId    String       @unique
  factsCollected    Json         @default("[]")
  topicsExplored    Json         @default("[]")
  unansweredAreas   Json         @default("[]")
  userFatigueScore  Float        @default(0)
  detectedTone      String?
  avgResponseLength Int          @default(0)
  usesEmoji         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationAnalysis {
  id             String       @id @default(cuid())
  conversationId String       @unique
  topicCoverage  Float
  sentimentScore Float
  keyQuotes      Json
  metadata       Json?
  themes         Json?
  sentiment      Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  metadata       Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model RewardGrant {
  id             String       @id @default(cuid())
  conversationId String       @unique
  userId         String?
  code           String?
  claimedAt      DateTime     @default(now())
  guestEmail     String?
  guestName      String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])
}

model QuestionDefinition {
  id      String             @id @default(cuid())
  botId   String
  type    String
  text    String
  options Json?
  bot     Bot                @relation(fields: [botId], references: [id], onDelete: Cascade)
  answers StructuredAnswer[]
}

model StructuredAnswer {
  id             String             @id @default(cuid())
  conversationId String
  questionId     String
  value          String
  conversation   Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  question       QuestionDefinition @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Theme {
  id          String            @id @default(cuid())
  botId       String
  name        String
  category    String?
  description String?
  bot         Bot               @relation(fields: [botId], references: [id], onDelete: Cascade)
  occurrences ThemeOccurrence[]

  @@index([botId])
}

model ThemeOccurrence {
  id             String       @id @default(cuid())
  themeId        String
  conversationId String
  strengthScore  Float
  snippet        String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  theme          Theme        @relation(fields: [themeId], references: [id], onDelete: Cascade)
}

model Insight {
  id        String @id @default(cuid())
  botId     String
  type      String @default("STRATEGIC")
  content   String
  citations Json?
  bot       Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model HotIdea {
  id      String @id @default(cuid())
  botId   String
  content String
  bot     Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model Report {
  id        String   @id @default(cuid())
  botId     String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MetricSummary {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  organizationId String
  type           UsageType
  count          Int          @default(1)
  tokensInput    Int?
  tokensOutput   Int?
  model          String?
  task           String?
  resourceId     String?
  metadata       Json?
  timestamp      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([organizationId, type, timestamp])
}

model ChatbotSession {
  id              String       @id @default(cuid())
  botId           String
  conversationId  String       @unique
  pageUrl         String
  pageTitle       String?
  pageDescription String?
  pageContent     String?
  sessionId       String
  userAgent       String?
  referrer        String?
  tokensUsed      Int          @default(0)
  messagesCount   Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  bot             Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([botId, sessionId])
  @@index([botId, createdAt])
}

model TokenUsage {
  id                    String       @id @default(cuid())
  organizationId        String       @unique
  periodStart           DateTime     @default(now())
  periodEnd             DateTime
  usedTokens            Int          @default(0)
  purchasedTokens       Int          @default(0)
  updatedAt             DateTime     @updatedAt
  aiSuggestionsUsed     Int          @default(0)
  chatbotSessionsUsed   Int          @default(0)
  chatbotTokens         Int          @default(0)
  interviewTokens       Int          @default(0)
  interviewsUsed        Int          @default(0)
  suggestionTokens      Int          @default(0)
  systemTokens          Int          @default(0)
  visibilityQueriesUsed Int          @default(0)
  visibilityTokens      Int          @default(0)
  copilotTokens         Int          @default(0)
  organization          Organization @relation(fields: [organizationId], references: [id])
}

model TokenLog {
  id              String        @id @default(cuid())
  organizationId  String
  userId          String?
  category        TokenCategory
  operation       String
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  resourceType    String?
  resourceId      String?
  model           String
  addOnId         String?
  createdAt       DateTime      @default(now())
  usedExtraTokens Boolean       @default(false)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, category])
  @@index([createdAt])
}

model PurchasedAddOn {
  id                    String       @id @default(cuid())
  type                  AddOnType
  quantity              Int
  remaining             Int
  purchasedAt           DateTime     @default(now())
  expiresAt             DateTime?
  amountPaid            Int
  currency              String       @default("eur")
  isActive              Boolean      @default(true)
  stripePaymentIntentId String?
  stripePriceId         String?
  stripeProductId       String?
  subscriptionId        String
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([subscriptionId, type, isActive])
}

model ChatbotAnalytics {
  id               String   @id @default(cuid())
  botId            String
  period           String
  sessionsCount    Int
  messagesCount    Int
  avgSessionLength Float
  leadsCollected   Int
  bounceRate       Float
  questionClusters Json
  knowledgeGaps    Json
  sentiment        Json
  createdAt        DateTime @default(now())
  bot              Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, period])
}

model KnowledgeGap {
  id           String    @id @default(cuid())
  botId        String
  topic        String
  priority     String
  evidence     Json
  suggestedFaq Json?
  status       String    @default("pending")
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bot          Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([botId, status])
}

model FaqSuggestion {
  id          String   @id @default(cuid())
  botId       String
  question    String
  answer      String
  confidence  Float
  occurrences Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([botId, status])
}

model CrossChannelInsight {
  id                String       @id @default(cuid())
  organizationId    String
  topicName         String
  interviewData     Json?
  chatbotData       Json?
  visibilityData    Json?
  crossChannelScore Float
  priorityScore     Float
  suggestedActions  Json
  status            String       @default("new")
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  projectId         String?
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project           Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, priorityScore])
  @@index([projectId])
}

model VisibilityConfig {
  id             String               @id @default(cuid())
  organizationId String
  brandName      String
  category       String
  description    String?
  language       String               @default("it")
  territory      String               @default("IT")
  isActive       Boolean              @default(true)
  nextScanAt     DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  projectId      String?
  competitors    Competitor[]
  serpScans      SerpMonitoringScan[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  prompts        VisibilityPrompt[]
  scans          VisibilityScan[]
}

model VisibilityPrompt {
  id               String               @id @default(cuid())
  text             String
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  configId         String?
  enabled          Boolean              @default(true)
  generatedByAI    Boolean              @default(false)
  lastEditedAt     DateTime             @default(now())
  orderIndex       Int                  @default(0)
  visibilityConfig VisibilityConfig?    @relation(fields: [configId], references: [id], onDelete: Cascade)
  responses        VisibilityResponse[]
}

model Competitor {
  id               String           @id @default(cuid())
  configId         String
  name             String
  website          String?
  enabled          Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

model VisibilityScan {
  id               String                 @id @default(cuid())
  configId         String
  startedAt        DateTime               @default(now())
  completedAt      DateTime?
  status           String                 @default("pending")
  scanType         String                 @default("manual")
  score            Float                  @default(0)
  responses        VisibilityResponse[]
  visibilityConfig VisibilityConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  metrics          VisibilityScanMetric[]
}

model VisibilityResponse {
  id                  String           @id @default(cuid())
  scanId              String
  promptId            String
  platform            String
  model               String
  responseText        String
  brandMentioned      Boolean
  brandPosition       Int?
  competitorPositions Json
  sentiment           String?
  sourcesCited        String[]
  tokenUsage          Json?
  createdAt           DateTime         @default(now())
  prompt              VisibilityPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  scan                VisibilityScan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

model VisibilityScanMetric {
  id         String         @id @default(cuid())
  scanId     String
  metricType String
  value      Float
  dimensions Json?
  scan       VisibilityScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

model SerpMonitoringScan {
  id               String           @id @default(cuid())
  configId         String
  scanType         String           @default("manual")
  query            String
  dateRange        String           @default("last_week")
  totalResults     Int              @default(0)
  positiveCount    Int              @default(0)
  negativeCount    Int              @default(0)
  neutralCount     Int              @default(0)
  avgImportance    Float            @default(0)
  startedAt        DateTime         @default(now())
  completedAt      DateTime?
  status           String           @default("pending")
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  results          SerpResult[]

  @@index([configId, startedAt])
}

model SerpResult {
  id                     String             @id @default(cuid())
  scanId                 String
  title                  String
  url                    String
  snippet                String
  displayedLink          String?
  publishedDate          DateTime?
  position               Int
  sourceDomain           String
  sourceType             String
  sourceReputation       Float              @default(50)
  sentiment              String
  sentimentScore         Float
  relevanceScore         Float
  importanceScore        Float
  brandMentionType       String
  topicCategory          String?
  keyEntities            Json?
  contentSummary         String?
  relatedToLLMVisibility Boolean            @default(false)
  suggestedActions       Json?
  isReviewed             Boolean            @default(false)
  reviewedBy             String?
  reviewedAt             DateTime?
  flagged                Boolean            @default(false)
  createdAt              DateTime           @default(now())
  scan                   SerpMonitoringScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId, importanceScore])
  @@index([scanId, sentiment])
}

model CMSConnection {
  id                        String              @id @default(cuid())
  name                      String
  cmsApiUrl                 String
  cmsDashboardUrl           String?
  cmsPublicUrl              String?
  apiKey                    String
  apiKeyPrefix              String
  apiKeyLastChars           String
  webhookSecret             String
  webhookUrl                String
  googleAnalyticsPropertyId String?
  googleAnalyticsConnected  Boolean             @default(false)
  searchConsoleSiteUrl      String?
  searchConsoleConnected    Boolean             @default(false)
  googleRefreshToken        String?
  googleTokenExpiresAt      DateTime?
  googleScopes              String[]
  status                    CMSConnectionStatus @default(PENDING)
  lastPingAt                DateTime?
  lastSyncAt                DateTime?
  lastSyncError             String?
  capabilities              String[]
  cmsVersion                String?
  brandingSyncEnabled       Boolean             @default(true)
  lastBrandingSyncAt        DateTime?
  notes                     String?
  enabledAt                 DateTime            @default(now())
  enabledBy                 String
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  projectId                 String              @unique
  project                   Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organizationId            String?
  organization              Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  suggestions               CMSSuggestion[]
  webhookLogs               CMSWebhookLog[]
  analytics                 WebsiteAnalytics[]
  integrationLogs           IntegrationLog[]

  @@index([organizationId])
}

model CMSWebhookLog {
  id             String           @id @default(cuid())
  connectionId   String
  direction      WebhookDirection
  event          String
  requestPayload Json?
  responseStatus Int?
  responseBody   String?
  success        Boolean
  errorMessage   String?
  createdAt      DateTime         @default(now())
  connection     CMSConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, createdAt])
}

model CMSSuggestion {
  id                    String              @id @default(cuid())
  connectionId          String
  crossChannelInsightId String?
  type                  CMSSuggestionType
  title                 String
  slug                  String?
  body                  String
  metaDescription       String?
  targetSection         String?
  reasoning             String
  sourceSignals         Json
  priorityScore         Int                 @default(50)
  status                CMSSuggestionStatus @default(PENDING)
  cmsContentId          String?
  cmsPreviewUrl         String?
  pushedAt              DateTime?
  publishedAt           DateTime?
  rejectedAt            DateTime?
  rejectedReason        String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Performance tracking
  performanceBefore Json? // Metriche pre-applicazione
  performanceAfter  Json? // Metriche post-applicazione (dopo 7 giorni)

  // Audit
  createdBy String? // Utente che ha generato/approvato

  connection CMSConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, status])
  @@index([connectionId, createdAt])
}

model WebsiteAnalytics {
  id                 String        @id @default(cuid())
  connectionId       String
  date               DateTime      @db.Date
  pageviews          Int           @default(0)
  uniqueVisitors     Int           @default(0)
  avgSessionDuration Int           @default(0)
  bounceRate         Float         @default(0)
  topPages           Json
  trafficSources     Json?
  searchImpressions  Int?
  searchClicks       Int?
  searchCtr          Float?
  avgSearchPosition  Float?
  topSearchQueries   Json?
  topSearchPages     Json?
  createdAt          DateTime      @default(now())
  connection         CMSConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, date])
  @@index([connectionId, date])
}

model CopilotSession {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  projectId      String?
  messagesCount  Int          @default(0)
  tokensUsed     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project?     @relation(fields: [projectId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

// ============================================
// SISTEMA CREDITI
// ============================================

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String
  projectId    String?
  executedById String? // chi ha eseguito l'azione (può essere collaboratore)
  amount       BigInt // crediti consumati
  balanceAfter BigInt // saldo dopo transazione
  type         String // usage, monthly_reset, pack_purchase, adjustment
  tool         String? // interview, chatbot, visibility, copilot, tips, export
  action       String? // azione specifica
  description  String?
  metadata     Json?
  createdAt    DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([projectId])
  @@index([type])
}

model CreditPack {
  id               String   @id @default(cuid())
  userId           String
  packType         String // small, medium, large
  creditsPurchased BigInt
  creditsRemaining BigInt
  pricePaid        Decimal  @db.Decimal(10, 2)
  stripePaymentId  String?
  purchasedAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SISTEMA ATTRIBUZIONE PARTNER-CLIENTE
// ============================================

model PartnerClientAttribution {
  id             String  @id @default(cuid())
  partnerId      String
  clientUserId   String  @unique // Un cliente può essere attribuito a UN solo partner
  firstProjectId String?

  attributedAt  DateTime  @default(now())
  status        String    @default("active") // active, revoked
  revokedAt     DateTime?
  revokedReason String?

  // Relazioni con onDelete per evitare errori referenziali
  partner      User     @relation("PartnerAttributions", fields: [partnerId], references: [id], onDelete: Cascade)
  clientUser   User     @relation("ClientAttribution", fields: [clientUserId], references: [id], onDelete: Cascade)
  firstProject Project? @relation("FirstAttributionProject", fields: [firstProjectId], references: [id], onDelete: SetNull)

  @@index([partnerId])
  @@index([partnerId, status])
}

enum ProjectRole {
  OWNER
  MEMBER
}

enum TokenCategory {
  INTERVIEW
  CHATBOT
  VISIBILITY
  SUGGESTION
  SYSTEM
}

enum AddOnType {
  TOKENS
  INTERVIEWS
  CHATBOT_SESSIONS
  VISIBILITY_QUERIES
  AI_SUGGESTIONS
  EXTRA_USERS
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
  USER
}

enum PlanType {
  FREE
  TRIAL
  STARTER
  PRO
  BUSINESS
  PARTNER
  ADMIN
}

enum UserPlanType {
  FREE
  TRIAL
  STARTER
  PRO
  BUSINESS
  PARTNER
  ADMIN
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
  TRIAL
  PARTNER
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum UsageEventType {
  INTERVIEW_COMPLETED
  BOT_PUBLISHED
  BOT_UNPUBLISHED
  USER_INVITED
}

enum UsageType {
  RESPONSE_COMPLETED
  SIMULATION
  AI_REGENERATION
  API_CALL
  TOKEN_USAGE
}

enum ResponseStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  LIMIT_REACHED
}

enum BotStatus {
  DRAFT
  PUBLISHED
  PAUSED
  ARCHIVED
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum CMSConnectionStatus {
  PENDING
  ACTIVE
  PARTIAL
  GOOGLE_ONLY
  ERROR
  DISABLED
}

enum WebhookDirection {
  INBOUND
  OUTBOUND
}

enum CMSSuggestionType {
  CREATE_PAGE
  CREATE_FAQ
  CREATE_BLOG_POST
  MODIFY_CONTENT
  ADD_SECTION
}

enum CMSSuggestionStatus {
  PENDING
  PUSHED
  PUBLISHED
  REJECTED
  FAILED
}

// ============================================
// EXTERNAL INTEGRATIONS (Business Tuner)
// ============================================

// MCP Connections (WordPress, WooCommerce)
model MCPConnection {
  id        String            @id @default(cuid())
  projectId String
  type      MCPConnectionType
  name      String

  // Endpoint MCP
  endpoint    String
  credentials String // Encrypted JSON (AES-256-GCM)

  // Stato
  status     ConnectionStatus @default(PENDING)
  lastPingAt DateTime?
  lastSyncAt DateTime?
  lastError  String?

  // Capabilities MCP
  availableTools String[]
  serverVersion  String?
  serverName     String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  project Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs    IntegrationLog[]

  @@unique([projectId, type])
  @@index([projectId, status])
}

enum MCPConnectionType {
  WORDPRESS
  WOOCOMMERCE
}

// Google Connections (GA4 + Search Console unificati)
model GoogleConnection {
  id        String @id @default(cuid())
  projectId String @unique

  // Service Account (condiviso tra GA4 e GSC)
  serviceAccountEmail String
  serviceAccountJson  String // Encrypted

  // Google Analytics 4
  ga4Enabled    Boolean          @default(false)
  ga4PropertyId String? // "123456789"
  ga4Status     ConnectionStatus @default(PENDING)
  ga4LastSyncAt DateTime?
  ga4LastError  String?

  // Search Console
  gscEnabled    Boolean          @default(false)
  gscSiteUrl    String? // "https://example.com" o "sc-domain:example.com"
  gscStatus     ConnectionStatus @default(PENDING)
  gscLastSyncAt DateTime?
  gscLastError  String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  project   Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics GoogleAnalyticsData[]
  logs      IntegrationLog[]

  @@index([projectId])
}

// Analytics data from Google (daily snapshots)
model GoogleAnalyticsData {
  id                 String   @id @default(cuid())
  googleConnectionId String
  date               DateTime @db.Date

  // GA4 metrics
  pageviews          Int   @default(0)
  sessions           Int   @default(0)
  users              Int   @default(0)
  avgSessionDuration Float @default(0)
  bounceRate         Float @default(0)
  topPages           Json?

  // Search Console metrics
  searchImpressions Int   @default(0)
  searchClicks      Int   @default(0)
  avgPosition       Float @default(0)
  topSearchQueries  Json?

  createdAt DateTime @default(now())

  googleConnection GoogleConnection @relation(fields: [googleConnectionId], references: [id], onDelete: Cascade)

  @@unique([googleConnectionId, date])
  @@index([googleConnectionId, date])
}

// Unified Integration Logs (polymorphic)
model IntegrationLog {
  id String @id @default(cuid())

  // Polymorphic relations (one of these will be set)
  mcpConnectionId    String?
  googleConnectionId String?
  cmsConnectionId    String?

  // Log data
  action       String // "wordpress.create_post", "ga4.run_report", etc.
  arguments    Json?
  result       Json?
  success      Boolean
  errorMessage String?
  creditsUsed  Int      @default(0)
  durationMs   Int
  createdAt    DateTime @default(now())

  // Relations
  mcpConnection    MCPConnection?    @relation(fields: [mcpConnectionId], references: [id], onDelete: Cascade)
  googleConnection GoogleConnection? @relation(fields: [googleConnectionId], references: [id], onDelete: Cascade)
  cmsConnection    CMSConnection?    @relation(fields: [cmsConnectionId], references: [id], onDelete: Cascade)

  @@index([mcpConnectionId, createdAt])
  @@index([googleConnectionId, createdAt])
  @@index([cmsConnectionId, createdAt])
}

// Shared status enum for all integrations
enum ConnectionStatus {
  PENDING
  TESTING
  ACTIVE
  ERROR
  DISABLED
}

model ItemTransferInvite {
  id       String           @id @default(cuid())
  itemType ItemTransferType
  itemId   String // ID of the Organization, Project, Bot, or Tool

  senderId       String // User ID of the person sending the transfer
  recipientEmail String // Email of the person who will receive it

  token  String         @unique
  status TransferStatus @default(PENDING)

  expiresAt  DateTime
  acceptedAt DateTime?

  // Relations
  sender  User     @relation("UserSentTransfers", fields: [senderId], references: [id])
  project Project? @relation("ProjectItemTransfers", fields: [itemId], references: [id], map: "ItemTransferInvite_projectId_fkey")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([recipientEmail])
  @@index([token])
}
