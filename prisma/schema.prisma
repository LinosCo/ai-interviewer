generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                     @id @default(cuid())
  name                    String?
  email                   String                     @unique
  emailVerified           DateTime?
  password                String?
  image                   String?
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt
  platformOpenaiApiKey    String?
  platformAnthropicApiKey String?
  role                    UserRole                   @default(USER)
  customApiKeys           Json?
  creditsResetDate        DateTime?
  isPartner               Boolean                    @default(false)
  monthlyCreditsLimit     BigInt                     @default(500)
  monthlyCreditsUsed      BigInt                     @default(0)
  packCreditsAvailable    BigInt                     @default(0)
  partnerActiveClients    Int                        @default(0)
  partnerCustomLogo       String?
  partnerFee              Int?
  partnerGracePeriodStart DateTime?
  partnerStatus           String?
  partnerTrialEndDate     DateTime?
  partnerWhiteLabel       Boolean                    @default(false)
  plan                    UserPlanType               @default(FREE)
  accounts                Account[]
  copilotSessions         CopilotSession[]
  creditPacks             CreditPack[]
  creditTransactions      CreditTransaction[]
  sentTransfers           ItemTransferInvite[]       @relation("UserSentTransfers")
  memberships             Membership[]
  clientAttribution       PartnerClientAttribution?  @relation("ClientAttribution")
  partnerAttributions     PartnerClientAttribution[] @relation("PartnerAttributions")
  passwordResetTokens     PasswordResetToken[]
  ownedProjects           Project[]
  projectAccess           ProjectAccess[]
  reports                 Report[]
  rewardGrants            RewardGrant[]
  sessions                Session[]
}

model ProjectAccess {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime    @default(now())
  role      ProjectRole @default(MEMBER)
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PlatformSettings {
  id                   String        @id @default(cuid())
  methodologyKnowledge String
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  strategicPlan        String?
  organizationId       String?       @unique
  organization         Organization?
}

model GlobalConfig {
  id                        String   @id @default("default")
  openaiApiKey              String?
  anthropicApiKey           String?
  stripeSecretKey           String?
  stripeWebhookSecret       String?
  stripePriceStarter        String?
  stripePricePro            String?
  stripePriceBusiness       String?
  updatedAt                 DateTime @updatedAt
  stripePriceProYearly      String?
  stripePriceStarterYearly  String?
  geminiApiKey              String?
  googleSerpApiKey          String?
  stripePriceBusinessYearly String?
  stripePricePackSmall      String?
  stripePricePackMedium     String?
  stripePricePackLarge      String?
  smtpHost                  String?
  smtpPort                  Int?
  smtpSecure                Boolean?
  smtpUser                  String?
  smtpPass                  String?
  smtpFromEmail             String?
  smtpNotificationEmail     String?
  resendApiKey              String?
  publicDemoBotId           String?
  stripePricePartner        String?
  stripePricePartnerYearly  String?
  stripePriceEnterprise     String?
  stripePriceEnterpriseYearly String?
}

model Organization {
  id                     String                 @id @default(cuid())
  name                   String
  slug                   String                 @unique
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  allowCustomApiKeys     Boolean                @default(false)
  plan                   PlanType               @default(FREE)
  billingCycle           BillingCycle           @default(MONTHLY)
  customLimits           Json?
  responsesUsedThisMonth Int                    @default(0)
  monthlyResetDate       DateTime               @default(now())
  address                String?
  city                   String?
  country                String                 @default("IT")
  postalCode             String?
  vatId                  String?
  strategicVision        String?
  valueProposition       String?
  cancelAtPeriodEnd      Boolean                @default(false)
  creditsResetDate       DateTime?
  currentMemberCount     Int                    @default(0)
  currentPeriodEnd       DateTime?
  currentPeriodStart     DateTime?
  extraMemberSlots       Int                    @default(0)
  maxMembers             Int                    @default(1)
  monthlyCreditsLimit    BigInt                 @default(500)
  monthlyCreditsUsed     BigInt                 @default(0)
  packCreditsAvailable   BigInt                 @default(0)
  stripeCustomerId       String?                @unique
  stripeSubscriptionId   String?
  subscriptionStatus     String?
  platformSettingsId     String?                @unique
  cmsConnections         CMSConnection[]
  copilotSessions        CopilotSession[]
  crossChannelInsights   CrossChannelInsight[]
  mcpConnections         MCPConnection[]
  members                Membership[]
  creditPacks            OrgCreditPack[]
  creditTransactions     OrgCreditTransaction[]
  invoices               OrgInvoice[]
  platformSettings       PlatformSettings?      @relation(fields: [platformSettingsId], references: [id])
  projects               Project[]
  subscription           Subscription?
  tokenLogs              TokenLog[]
  tokenUsage             TokenUsage?
  usageLogs              UsageLog[]
  visibilityConfigs      VisibilityConfig[]
}

model Subscription {
  id                             String             @id @default(cuid())
  organizationId                 String             @unique
  tier                           SubscriptionTier   @default(TRIAL)
  status                         SubscriptionStatus @default(TRIALING)
  stripeCustomerId               String?            @unique
  stripeSubscriptionId           String?            @unique
  stripePriceId                  String?
  currentPeriodStart             DateTime           @default(now())
  currentPeriodEnd               DateTime?
  interviewsUsedThisMonth        Int                @default(0)
  billingEmail                   String?
  billingName                    String?
  vatNumber                      String?
  createdAt                      DateTime           @default(now())
  updatedAt                      DateTime           @updatedAt
  canceledAt                     DateTime?
  codiceFiscale                  String?
  pecEmail                       String?
  sdiCode                        String?
  customLimits                   Json?
  aiSuggestionsUsedThisMonth     Int                @default(0)
  chatbotSessionsUsedThisMonth   Int                @default(0)
  extraChatbotSessions           Int                @default(0)
  extraInterviews                Int                @default(0)
  extraUsers                     Int                @default(0)
  extraVisibilityQueries         Int                @default(0)
  isPartner                      Boolean            @default(false)
  tokensUsedThisMonth            Int                @default(0)
  trialEndsAt                    DateTime?
  visibilityQueriesUsedThisMonth Int                @default(0)
  billingAddress                 Json?
  cancelAtPeriodEnd              Boolean            @default(false)
  chatbotTokensUsed              Int                @default(0)
  extraAiSuggestions             Int                @default(0)
  extraTokens                    Int                @default(0)
  interviewTokensUsed            Int                @default(0)
  suggestionTokensUsed           Int                @default(0)
  systemTokensUsed               Int                @default(0)
  visibilityTokensUsed           Int                @default(0)
  invoices                       Invoice[]
  purchasedAddOns                PurchasedAddOn[]
  organization                   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Invoice {
  id              String       @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String       @unique
  amountPaid      Int
  currency        String       @default("eur")
  status          String
  pdfUrl          String?
  createdAt       DateTime     @default(now())
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])
}

model UsageEvent {
  id             String         @id @default(cuid())
  organizationId String
  eventType      UsageEventType
  resourceId     String?
  metadata       Json?
  createdAt      DateTime       @default(now())

  @@index([organizationId, createdAt])
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           Role         @default(MEMBER)
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  invitedAt      DateTime?
  invitedBy      String?
  joinedAt       DateTime?
  receiveAlerts  Boolean      @default(true)
  status         MemberStatus @default(ACTIVE)
  updatedAt      DateTime     @default(now()) @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Project {
  id                   String                     @id @default(cuid())
  name                 String
  organizationId       String?
  ownerId              String?
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  isPersonal           Boolean                    @default(false)
  strategicVision      String?
  valueProposition     String?
  originPartnerId      String?
  transferredAt        DateTime?
  transferredToUserId  String?
  transferredFromOrgId String?
  cmsConnectionId      String?
  bots                 Bot[]
  newCmsConnection     CMSConnection?             @relation("NewCMSAssociation")
  copilotSessions      CopilotSession[]
  creditTransactions   CreditTransaction[]
  crossChannelInsights CrossChannelInsight[]
  googleConnection     GoogleConnection?
  n8nConnection        N8NConnection?
  itemTransfers        ItemTransferInvite[]       @relation("ProjectItemTransfers")
  mcpConnections       MCPConnection[]
  firstAttributions    PartnerClientAttribution[] @relation("FirstAttributionProject")
  cmsConnection        CMSConnection?             @relation("ProjectToCMS", fields: [cmsConnectionId], references: [id])
  organization         Organization?              @relation(fields: [organizationId], references: [id])
  owner                User?                      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  accessList           ProjectAccess[]
  cmsShares            ProjectCMSConnection[]
  mcpShares            ProjectMCPConnection[]
  projectTransfersTo   ProjectTransfer[]          @relation("DuplicatedProject")
  projectTransfersFrom ProjectTransfer[]          @relation("OriginalProject")
  visibilityShares     ProjectVisibilityConfig[]
  visibilityConfigs    VisibilityConfig[]
}

model OrgCreditTransaction {
  id             String       @id @default(cuid())
  organizationId String
  projectId      String?
  executedById   String?
  amount         BigInt
  balanceAfter   BigInt
  type           String
  tool           String?
  action         String?
  description    String?
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([projectId])
  @@index([type])
}

model OrgCreditPack {
  id               String       @id @default(cuid())
  organizationId   String
  packType         String
  creditsPurchased BigInt
  creditsRemaining BigInt
  pricePaid        Decimal      @db.Decimal(10, 2)
  stripePaymentId  String?
  purchasedAt      DateTime     @default(now())
  purchasedBy      String?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model OrgInvoice {
  id              String       @id @default(cuid())
  organizationId  String
  stripeInvoiceId String       @unique
  amountPaid      Int
  currency        String       @default("eur")
  status          String
  invoiceNumber   String?
  pdfUrl          String?
  hostedUrl       String?
  periodStart     DateTime?
  periodEnd       DateTime?
  vatNumber       String?
  companyName     String?
  billingAddress  Json?
  createdAt       DateTime     @default(now())
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeInvoiceId])
}

model StripeWebhookEvent {
  id              String    @id @default(cuid())
  eventId         String    @unique
  eventType       String
  payload         Json?
  processedAt     DateTime?
  processingError String?
  createdAt       DateTime  @default(now())

  @@index([eventType, createdAt])
}

model ProjectTransfer {
  id                  String   @id @default(cuid())
  originalProjectId   String
  duplicatedProjectId String
  partnerId           String
  transferredAt       DateTime @default(now())
  clientUserId        String
  includeData         Boolean  @default(false)
  originalOrgId       String
  partnerKeepsAccess  Boolean  @default(true)
  targetOrgId         String
  duplicatedProject   Project  @relation("DuplicatedProject", fields: [duplicatedProjectId], references: [id])
  originalProject     Project  @relation("OriginalProject", fields: [originalProjectId], references: [id])

  @@index([partnerId])
  @@index([clientUserId])
}

model ProjectTransferInvite {
  id                 String    @id @default(cuid())
  projectId          String
  partnerId          String
  clientEmail        String
  token              String    @unique
  status             String    @default("pending")
  expiresAt          DateTime
  createdAt          DateTime  @default(now())
  acceptedAt         DateTime?
  includeData        Boolean   @default(false)
  partnerKeepsAccess Boolean   @default(true)
  personalMessage    String?

  @@index([token])
  @@index([partnerId])
  @@index([clientEmail])
}

model OrganizationInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           Role      @default(MEMBER)
  token          String    @unique
  invitedById    String
  message        String?
  status         String    @default("PENDING")
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())

  @@unique([organizationId, email])
}

model Bot {
  id                    String               @id @default(cuid())
  projectId             String
  slug                  String               @unique
  name                  String
  description           String?
  status                BotStatus            @default(DRAFT)
  researchGoal          String?
  targetAudience        String?
  language              String               @default("en")
  tone                  String?
  introMessage          String?
  maxDurationMins       Int                  @default(10)
  maxTurns              Int                  @default(20)
  maxOpenQuestions      Int                  @default(5)
  modelProvider         String               @default("openai")
  modelName             String               @default("gpt-4o-mini")
  openaiApiKey          String?
  anthropicApiKey       String?
  logoUrl               String?
  primaryColor          String               @default("#6366f1")
  backgroundColor       String               @default("#ffffff")
  textColor             String               @default("#1f2937")
  anonymizationLevel    String               @default("partial")
  privacyNotice         String?
  dataUsageInfo         String?
  consentText           String?
  showAnonymityInfo     Boolean              @default(true)
  showDataUsageInfo     Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  analyticsMetadata     Json?
  formatExplanation     String?
  progressBarStyle      String               @default("semantic")
  showProgressBar       Boolean              @default(true)
  showTopicPreview      Boolean              @default(false)
  welcomeSubtitle       String?
  welcomeTitle          String?
  warmupChoices         Json?
  warmupContextPrompt   String?
  warmupFollowup        Boolean              @default(true)
  warmupIcebreaker      String?
  warmupStyle           String               @default("open")
  useWarmup             Boolean              @default(true)
  landingDescription    String?
  landingImageUrl       String?
  landingTitle          String?
  landingVideoUrl       String?
  candidateDataFields   Json?
  collectCandidateData  Boolean              @default(false)
  allowedDomains        Json?
  botType               String               @default("interview")
  bubbleAnimation       String               @default("bounce")
  bubbleIcon            String?
  bubblePosition        String               @default("bottom-right")
  bubbleSize            String               @default("medium")
  enablePageContext     Boolean              @default(true)
  fallbackMessage       String?
  leadCaptureMessage    String?
  leadCaptureStrategy   String               @default("after_3_msgs")
  maxMessagesPerSession Int                  @default(20)
  maxTokensPerMessage   Int                  @default(500)
  webhookUrl            String?
  privacyPolicyUrl      String?
  boundaries            Json?
  project               Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics             ChatbotAnalytics[]
  chatbotSessions       ChatbotSession[]
  conversations         Conversation[]
  faqSuggestions        FaqSuggestion[]
  hotIdeas              HotIdea[]
  insights              Insight[]
  interviewPlan         InterviewPlan?
  knowledgeGaps         KnowledgeGap[]
  knowledgeSources      KnowledgeSource[]
  questionDefinitions   QuestionDefinition[]
  reports               Report[]
  rewardConfig          RewardConfig?
  themes                Theme[]
  topics                TopicBlock[]
}

model InterviewPlan {
  id        String   @id @default(cuid())
  botId     String   @unique
  basePlan  Json
  overrides Json?
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model KnowledgeSource {
  id        String   @id @default(cuid())
  botId     String
  type      String
  title     String?
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model TopicBlock {
  id          String   @id @default(cuid())
  botId       String
  orderIndex  Int
  label       String
  description String?
  subGoals    String[]
  maxTurns    Int      @default(5)
  keywords    Json?
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, orderIndex])
}

model RewardConfig {
  id            String  @id @default(cuid())
  botId         String  @unique
  enabled       Boolean @default(false)
  type          String
  payload       String
  displayText   String?
  showOnLanding Boolean @default(true)
  bot           Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Conversation {
  id                String                @id @default(cuid())
  botId             String
  participantId     String
  status            String
  fatigueScore      Int                   @default(0)
  currentTopicId    String?
  startedAt         DateTime              @default(now())
  completedAt       DateTime?
  durationSeconds   Int?
  effectiveDuration Int                   @default(0)
  sentimentScore    Float?
  tags              String[]
  exchangeCount     Int                   @default(0)
  totalTokens       Int                   @default(0)
  metadata          Json?
  candidateProfile  Json?
  chatbotSession    ChatbotSession?
  bot               Bot                   @relation(fields: [botId], references: [id], onDelete: Cascade)
  analysis          ConversationAnalysis?
  memory            ConversationMemory?
  messages          Message[]
  rewardGrant       RewardGrant?
  answers           StructuredAnswer[]
  themeOccurrences  ThemeOccurrence[]

  @@index([botId])
  @@index([botId, status])
  @@index([botId, startedAt])
}

model ConversationMemory {
  id                String       @id @default(cuid())
  conversationId    String       @unique
  factsCollected    Json         @default("[]")
  topicsExplored    Json         @default("[]")
  unansweredAreas   Json         @default("[]")
  userFatigueScore  Float        @default(0)
  detectedTone      String?
  avgResponseLength Int          @default(0)
  usesEmoji         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationAnalysis {
  id             String       @id @default(cuid())
  conversationId String       @unique
  topicCoverage  Float
  sentimentScore Float
  keyQuotes      Json
  metadata       Json?
  themes         Json?
  sentiment      Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  metadata       Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model RewardGrant {
  id             String       @id @default(cuid())
  conversationId String       @unique
  userId         String?
  code           String?
  claimedAt      DateTime     @default(now())
  guestEmail     String?
  guestName      String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])
}

model QuestionDefinition {
  id      String             @id @default(cuid())
  botId   String
  type    String
  text    String
  options Json?
  bot     Bot                @relation(fields: [botId], references: [id], onDelete: Cascade)
  answers StructuredAnswer[]
}

model StructuredAnswer {
  id             String             @id @default(cuid())
  conversationId String
  questionId     String
  value          String
  conversation   Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  question       QuestionDefinition @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Theme {
  id          String            @id @default(cuid())
  botId       String
  name        String
  category    String?
  description String?
  bot         Bot               @relation(fields: [botId], references: [id], onDelete: Cascade)
  occurrences ThemeOccurrence[]

  @@index([botId])
}

model ThemeOccurrence {
  id             String       @id @default(cuid())
  themeId        String
  conversationId String
  strengthScore  Float
  snippet        String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  theme          Theme        @relation(fields: [themeId], references: [id], onDelete: Cascade)
}

model Insight {
  id        String @id @default(cuid())
  botId     String
  type      String @default("STRATEGIC")
  content   String
  citations Json?
  bot       Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model HotIdea {
  id      String @id @default(cuid())
  botId   String
  content String
  bot     Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
}

model Report {
  id        String   @id @default(cuid())
  botId     String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MetricSummary {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  organizationId String
  type           UsageType
  count          Int          @default(1)
  tokensInput    Int?
  tokensOutput   Int?
  model          String?
  task           String?
  resourceId     String?
  metadata       Json?
  timestamp      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([organizationId, type, timestamp])
}

model ChatbotSession {
  id              String       @id @default(cuid())
  botId           String
  conversationId  String       @unique
  pageUrl         String
  pageTitle       String?
  pageDescription String?
  pageContent     String?
  sessionId       String
  userAgent       String?
  referrer        String?
  tokensUsed      Int          @default(0)
  messagesCount   Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  bot             Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([botId, sessionId])
  @@index([botId, createdAt])
}

model TokenUsage {
  id                    String       @id @default(cuid())
  organizationId        String       @unique
  periodStart           DateTime     @default(now())
  periodEnd             DateTime
  usedTokens            Int          @default(0)
  purchasedTokens       Int          @default(0)
  updatedAt             DateTime     @updatedAt
  aiSuggestionsUsed     Int          @default(0)
  chatbotSessionsUsed   Int          @default(0)
  chatbotTokens         Int          @default(0)
  interviewTokens       Int          @default(0)
  interviewsUsed        Int          @default(0)
  suggestionTokens      Int          @default(0)
  systemTokens          Int          @default(0)
  visibilityQueriesUsed Int          @default(0)
  visibilityTokens      Int          @default(0)
  copilotTokens         Int          @default(0)
  organization          Organization @relation(fields: [organizationId], references: [id])
}

model TokenLog {
  id              String        @id @default(cuid())
  organizationId  String
  userId          String?
  category        TokenCategory
  operation       String
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  resourceType    String?
  resourceId      String?
  model           String
  addOnId         String?
  createdAt       DateTime      @default(now())
  usedExtraTokens Boolean       @default(false)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, category])
  @@index([createdAt])
}

model PurchasedAddOn {
  id                    String       @id @default(cuid())
  type                  AddOnType
  quantity              Int
  remaining             Int
  purchasedAt           DateTime     @default(now())
  expiresAt             DateTime?
  amountPaid            Int
  currency              String       @default("eur")
  isActive              Boolean      @default(true)
  stripePaymentIntentId String?
  stripePriceId         String?
  stripeProductId       String?
  subscriptionId        String
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([subscriptionId, type, isActive])
}

model ChatbotAnalytics {
  id               String   @id @default(cuid())
  botId            String
  period           String
  sessionsCount    Int
  messagesCount    Int
  avgSessionLength Float
  leadsCollected   Int
  bounceRate       Float
  questionClusters Json
  knowledgeGaps    Json
  sentiment        Json
  createdAt        DateTime @default(now())
  bot              Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, period])
}

model KnowledgeGap {
  id           String    @id @default(cuid())
  botId        String
  topic        String
  priority     String
  evidence     Json
  suggestedFaq Json?
  status       String    @default("pending")
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bot          Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([botId, status])
}

model FaqSuggestion {
  id          String   @id @default(cuid())
  botId       String
  question    String
  answer      String
  confidence  Float
  occurrences Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([botId, status])
}

model CrossChannelInsight {
  id                String       @id @default(cuid())
  organizationId    String
  topicName         String
  interviewData     Json?
  chatbotData       Json?
  visibilityData    Json?
  crossChannelScore Float
  priorityScore     Float
  suggestedActions  Json
  status            String       @default("new")
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  projectId         String?
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project           Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, priorityScore])
  @@index([projectId])
}

model VisibilityConfig {
  id              String                    @id @default(cuid())
  organizationId  String
  brandName       String
  category        String
  description     String?
  language        String                    @default("it")
  territory       String                    @default("IT")
  isActive        Boolean                   @default(true)
  nextScanAt      DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  projectId       String?
  websiteUrl      String?
  additionalUrls  Json?
  competitors     Competitor[]
  projectShares   ProjectVisibilityConfig[]
  serpScans       SerpMonitoringScan[]
  tipActions      TipAction[]
  organization    Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project?                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  prompts         VisibilityPrompt[]
  scans           VisibilityScan[]
  websiteAnalyses WebsiteAnalysis[]
}

model VisibilityPrompt {
  id                  String               @id @default(cuid())
  text                String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  configId            String?
  enabled             Boolean              @default(true)
  generatedByAI       Boolean              @default(false)
  lastEditedAt        DateTime             @default(now())
  orderIndex          Int                  @default(0)
  aiOverviewEnabled   Boolean              @default(true)
  aiOverviewLastFound DateTime?
  aiOverviewVariant   String?
  referenceUrl        String?
  visibilityConfig    VisibilityConfig?    @relation(fields: [configId], references: [id], onDelete: Cascade)
  responses           VisibilityResponse[]
}

model Competitor {
  id               String           @id @default(cuid())
  configId         String
  name             String
  website          String?
  enabled          Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

model VisibilityScan {
  id               String                 @id @default(cuid())
  configId         String
  startedAt        DateTime               @default(now())
  completedAt      DateTime?
  status           String                 @default("pending")
  scanType         String                 @default("manual")
  score            Float                  @default(0)
  responses        VisibilityResponse[]
  visibilityConfig VisibilityConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  metrics          VisibilityScanMetric[]
}

model VisibilityResponse {
  id                  String           @id @default(cuid())
  scanId              String
  promptId            String
  platform            String
  model               String
  responseText        String
  brandMentioned      Boolean
  brandPosition       Int?
  competitorPositions Json
  sentiment           String?
  sourcesCited        String[]
  tokenUsage          Json?
  createdAt           DateTime         @default(now())
  prompt              VisibilityPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  scan                VisibilityScan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

model VisibilityScanMetric {
  id         String         @id @default(cuid())
  scanId     String
  metricType String
  value      Float
  dimensions Json?
  scan       VisibilityScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

model WebsiteAnalysis {
  id                    String           @id @default(cuid())
  configId              String
  websiteUrl            String
  status                String           @default("pending")
  overallScore          Int              @default(0)
  structuredDataScore   Int              @default(0)
  valuePropositionScore Int              @default(0)
  keywordCoverageScore  Int              @default(0)
  contentClarityScore   Int              @default(0)
  structuredDataFound   Json?
  valuePropositions     Json?
  keywordAnalysis       Json?
  contentAnalysis       Json?
  recommendations       Json?
  promptsAddressed      Json?
  pageTitle             String?
  pageDescription       String?
  contentLength         Int?
  pagesScraped          Int              @default(1)
  startedAt             DateTime         @default(now())
  completedAt           DateTime?
  errorMessage          String?
  visibilityConfig      VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId, completedAt])
}

model TipAction {
  id               String           @id @default(cuid())
  configId         String
  tipKey           String
  tipTitle         String
  tipType          String
  status           String           @default("active")
  completedAt      DateTime?
  dismissedAt      DateTime?
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, tipKey])
  @@index([configId, status])
}

model SerpMonitoringScan {
  id               String           @id @default(cuid())
  configId         String
  scanType         String           @default("manual")
  query            String
  dateRange        String           @default("last_week")
  totalResults     Int              @default(0)
  positiveCount    Int              @default(0)
  negativeCount    Int              @default(0)
  neutralCount     Int              @default(0)
  avgImportance    Float            @default(0)
  startedAt        DateTime         @default(now())
  completedAt      DateTime?
  status           String           @default("pending")
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  results          SerpResult[]

  @@index([configId, startedAt])
}

model SerpResult {
  id                     String             @id @default(cuid())
  scanId                 String
  title                  String
  url                    String
  snippet                String
  displayedLink          String?
  publishedDate          DateTime?
  position               Int
  sourceDomain           String
  sourceType             String
  sourceReputation       Float              @default(50)
  sentiment              String
  sentimentScore         Float
  relevanceScore         Float
  importanceScore        Float
  brandMentionType       String
  topicCategory          String?
  keyEntities            Json?
  contentSummary         String?
  relatedToLLMVisibility Boolean            @default(false)
  suggestedActions       Json?
  isReviewed             Boolean            @default(false)
  reviewedBy             String?
  reviewedAt             DateTime?
  flagged                Boolean            @default(false)
  createdAt              DateTime           @default(now())
  scan                   SerpMonitoringScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId, importanceScore])
  @@index([scanId, sentiment])
}

model CMSConnection {
  id                        String                 @id @default(cuid())
  name                      String
  cmsApiUrl                 String
  cmsDashboardUrl           String?
  cmsPublicUrl              String?
  apiKey                    String
  apiKeyPrefix              String
  apiKeyLastChars           String
  webhookSecret             String
  webhookUrl                String
  googleAnalyticsPropertyId String?
  googleAnalyticsConnected  Boolean                @default(false)
  searchConsoleSiteUrl      String?
  searchConsoleConnected    Boolean                @default(false)
  googleRefreshToken        String?
  googleTokenExpiresAt      DateTime?
  googleScopes              String[]
  status                    CMSConnectionStatus    @default(PENDING)
  lastPingAt                DateTime?
  lastSyncAt                DateTime?
  lastSyncError             String?
  capabilities              String[]
  cmsVersion                String?
  brandingSyncEnabled       Boolean                @default(true)
  lastBrandingSyncAt        DateTime?
  notes                     String?
  enabledAt                 DateTime               @default(now())
  enabledBy                 String
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  organizationId            String?
  projectId                 String?                @unique
  organization              Organization?          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                   Project?               @relation("NewCMSAssociation", fields: [projectId], references: [id], onDelete: Cascade)
  suggestions               CMSSuggestion[]
  webhookLogs               CMSWebhookLog[]
  integrationLogs           IntegrationLog[]
  projects                  Project[]              @relation("ProjectToCMS")
  projectShares             ProjectCMSConnection[]
  analytics                 WebsiteAnalytics[]

  @@index([organizationId])
}

model CMSWebhookLog {
  id             String           @id @default(cuid())
  connectionId   String
  direction      WebhookDirection
  event          String
  requestPayload Json?
  responseStatus Int?
  responseBody   String?
  success        Boolean
  errorMessage   String?
  createdAt      DateTime         @default(now())
  connection     CMSConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, createdAt])
}

model CMSSuggestion {
  id                    String              @id @default(cuid())
  connectionId          String
  crossChannelInsightId String?
  type                  CMSSuggestionType
  title                 String
  slug                  String?
  body                  String
  metaDescription       String?
  targetSection         String?
  reasoning             String
  sourceSignals         Json
  priorityScore         Int                 @default(50)
  status                CMSSuggestionStatus @default(PENDING)
  cmsContentId          String?
  cmsPreviewUrl         String?
  pushedAt              DateTime?
  publishedAt           DateTime?
  rejectedAt            DateTime?
  rejectedReason        String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  performanceBefore     Json?
  performanceAfter      Json?
  createdBy             String?
  connection            CMSConnection       @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, status])
  @@index([connectionId, createdAt])
}

model WebsiteAnalytics {
  id                 String        @id @default(cuid())
  connectionId       String
  date               DateTime      @db.Date
  pageviews          Int           @default(0)
  uniqueVisitors     Int           @default(0)
  avgSessionDuration Int           @default(0)
  bounceRate         Float         @default(0)
  topPages           Json
  trafficSources     Json?
  searchImpressions  Int?
  searchClicks       Int?
  searchCtr          Float?
  avgSearchPosition  Float?
  topSearchQueries   Json?
  topSearchPages     Json?
  createdAt          DateTime      @default(now())
  connection         CMSConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, date])
  @@index([connectionId, date])
}

model CopilotSession {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  projectId      String?
  messagesCount  Int          @default(0)
  tokensUsed     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project?     @relation(fields: [projectId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
}

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String
  projectId    String?
  executedById String?
  amount       BigInt
  balanceAfter BigInt
  type         String
  tool         String?
  action       String?
  description  String?
  metadata     Json?
  createdAt    DateTime @default(now())
  project      Project? @relation(fields: [projectId], references: [id])
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([projectId])
  @@index([type])
}

model CreditPack {
  id               String   @id @default(cuid())
  userId           String
  packType         String
  creditsPurchased BigInt
  creditsRemaining BigInt
  pricePaid        Decimal  @db.Decimal(10, 2)
  stripePaymentId  String?
  purchasedAt      DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PartnerClientAttribution {
  id             String    @id @default(cuid())
  partnerId      String
  clientUserId   String    @unique
  firstProjectId String?
  attributedAt   DateTime  @default(now())
  status         String    @default("active")
  revokedAt      DateTime?
  revokedReason  String?
  clientUser     User      @relation("ClientAttribution", fields: [clientUserId], references: [id], onDelete: Cascade)
  firstProject   Project?  @relation("FirstAttributionProject", fields: [firstProjectId], references: [id])
  partner        User      @relation("PartnerAttributions", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([partnerId, status])
}

model MCPConnection {
  id             String                 @id @default(cuid())
  projectId      String
  type           MCPConnectionType
  name           String
  endpoint       String
  credentials    String
  status         ConnectionStatus       @default(PENDING)
  lastPingAt     DateTime?
  lastSyncAt     DateTime?
  lastError      String?
  availableTools String[]
  serverVersion  String?
  serverName     String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  createdBy      String
  organizationId String?
  logs           IntegrationLog[]
  organization   Organization?          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectShares  ProjectMCPConnection[]

  @@unique([projectId, type])
  @@index([projectId, status])
  @@index([organizationId])
}

model GoogleConnection {
  id                  String                @id @default(cuid())
  projectId           String                @unique
  serviceAccountEmail String
  serviceAccountJson  String
  ga4Enabled          Boolean               @default(false)
  ga4PropertyId       String?
  ga4Status           ConnectionStatus      @default(PENDING)
  ga4LastSyncAt       DateTime?
  ga4LastError        String?
  gscEnabled          Boolean               @default(false)
  gscSiteUrl          String?
  gscStatus           ConnectionStatus      @default(PENDING)
  gscLastSyncAt       DateTime?
  gscLastError        String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String
  analytics           GoogleAnalyticsData[]
  project             Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs                IntegrationLog[]

  @@index([projectId])
}

model GoogleAnalyticsData {
  id                 String           @id @default(cuid())
  googleConnectionId String
  date               DateTime         @db.Date
  pageviews          Int              @default(0)
  sessions           Int              @default(0)
  users              Int              @default(0)
  avgSessionDuration Float            @default(0)
  bounceRate         Float            @default(0)
  topPages           Json?
  searchImpressions  Int              @default(0)
  searchClicks       Int              @default(0)
  avgPosition        Float            @default(0)
  topSearchQueries   Json?
  createdAt          DateTime         @default(now())
  googleConnection   GoogleConnection @relation(fields: [googleConnectionId], references: [id], onDelete: Cascade)

  @@unique([googleConnectionId, date])
  @@index([googleConnectionId, date])
}

model N8NConnection {
  id             String           @id @default(cuid())
  projectId      String           @unique
  name           String           @default("n8n Automation")
  webhookUrl     String
  status         ConnectionStatus @default(PENDING)
  lastTriggerAt  DateTime?
  lastError      String?
  triggerOnTips  Boolean          @default(true) // Auto-trigger when AI tips are generated
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  createdBy      String
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model IntegrationLog {
  id                 String            @id @default(cuid())
  mcpConnectionId    String?
  googleConnectionId String?
  cmsConnectionId    String?
  action             String
  arguments          Json?
  result             Json?
  success            Boolean
  errorMessage       String?
  creditsUsed        Int               @default(0)
  durationMs         Int
  createdAt          DateTime          @default(now())
  cmsConnection      CMSConnection?    @relation(fields: [cmsConnectionId], references: [id], onDelete: Cascade)
  googleConnection   GoogleConnection? @relation(fields: [googleConnectionId], references: [id], onDelete: Cascade)
  mcpConnection      MCPConnection?    @relation(fields: [mcpConnectionId], references: [id], onDelete: Cascade)

  @@index([mcpConnectionId, createdAt])
  @@index([googleConnectionId, createdAt])
  @@index([cmsConnectionId, createdAt])
}

model ItemTransferInvite {
  id             String           @id @default(cuid())
  itemType       ItemTransferType
  itemId         String
  senderId       String
  recipientEmail String
  token          String           @unique
  status         TransferStatus   @default(PENDING)
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  project        Project          @relation("ProjectItemTransfers", fields: [itemId], references: [id], map: "ItemTransferInvite_projectId_fkey")
  sender         User             @relation("UserSentTransfers", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([recipientEmail])
  @@index([token])
}

model ProjectCMSConnection {
  id           String        @id @default(cuid())
  projectId    String
  connectionId String
  role         String        @default("VIEWER")
  createdAt    DateTime      @default(now())
  createdBy    String?
  connection   CMSConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, connectionId])
  @@index([projectId])
  @@index([connectionId])
}

model ProjectMCPConnection {
  id           String        @id @default(cuid())
  projectId    String
  connectionId String
  role         String        @default("VIEWER")
  createdAt    DateTime      @default(now())
  createdBy    String?
  connection   MCPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, connectionId])
  @@index([projectId])
  @@index([connectionId])
}

model ProjectVisibilityConfig {
  id        String           @id @default(cuid())
  projectId String
  configId  String
  role      String           @default("VIEWER")
  createdAt DateTime         @default(now())
  createdBy String?
  config    VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, configId])
  @@index([projectId])
  @@index([configId])
}

enum MemberStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum ItemTransferType {
  ORGANIZATION
  PROJECT
  BOT
  TOOL
}

enum TransferStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum ProjectRole {
  OWNER
  MEMBER
}

enum TokenCategory {
  INTERVIEW
  CHATBOT
  VISIBILITY
  SUGGESTION
  SYSTEM
}

enum AddOnType {
  TOKENS
  INTERVIEWS
  CHATBOT_SESSIONS
  VISIBILITY_QUERIES
  AI_SUGGESTIONS
  EXTRA_USERS
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
  USER
}

enum PlanType {
  TRIAL
  STARTER
  PRO
  BUSINESS
  FREE
  PARTNER
  ENTERPRISE
  ADMIN
}

enum UserPlanType {
  FREE
  TRIAL
  STARTER
  PRO
  BUSINESS
  PARTNER
  ENTERPRISE
  ADMIN
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
  TRIAL
  PARTNER
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum UsageEventType {
  INTERVIEW_COMPLETED
  BOT_PUBLISHED
  BOT_UNPUBLISHED
  USER_INVITED
}

enum UsageType {
  RESPONSE_COMPLETED
  SIMULATION
  AI_REGENERATION
  API_CALL
  TOKEN_USAGE
}

enum ResponseStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  LIMIT_REACHED
}

enum BotStatus {
  DRAFT
  PUBLISHED
  PAUSED
  ARCHIVED
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum CMSConnectionStatus {
  PENDING
  ACTIVE
  PARTIAL
  GOOGLE_ONLY
  ERROR
  DISABLED
}

enum WebhookDirection {
  INBOUND
  OUTBOUND
}

enum CMSSuggestionType {
  CREATE_PAGE
  CREATE_FAQ
  CREATE_BLOG_POST
  MODIFY_CONTENT
  ADD_SECTION
}

enum CMSSuggestionStatus {
  PENDING
  PUSHED
  PUBLISHED
  REJECTED
  FAILED
}

enum MCPConnectionType {
  WORDPRESS
  WOOCOMMERCE
}

enum ConnectionStatus {
  PENDING
  TESTING
  ACTIVE
  ERROR
  DISABLED
}
