generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String               @id @default(cuid())
  name                    String?
  email                   String               @unique
  emailVerified           DateTime?
  password                String?
  image                   String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  platformOpenaiApiKey    String?
  platformAnthropicApiKey String?
  role                    UserRole             @default(USER)
  customApiKeys           Json?
  accounts                Account[]
  memberships             Membership[]
  passwordResetTokens     PasswordResetToken[]
  platformSettings        PlatformSettings?
  ownedProjects           Project[]
  projectAccess           ProjectAccess[]
  reports                 Report[]
  rewardGrants            RewardGrant[]
  sessions                Session[]
}

model ProjectAccess {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

enum ProjectRole {
  OWNER
  MEMBER
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PlatformSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  methodologyKnowledge String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GlobalConfig {
  id                       String   @id @default("default")
  openaiApiKey             String?
  anthropicApiKey          String?
  geminiApiKey             String?
  googleSerpApiKey         String?
  stripeSecretKey          String?
  stripeWebhookSecret      String?
  stripePriceStarter       String?
  stripePricePro           String?
  stripePriceBusiness      String?
  updatedAt                DateTime @updatedAt
  stripePriceProYearly     String?
  stripePriceStarterYearly String?
}

model Organization {
  id                     String                @id @default(cuid())
  name                   String
  slug                   String                @unique
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  allowCustomApiKeys     Boolean               @default(false)
  plan                   PlanType              @default(TRIAL)
  billingCycle           BillingCycle          @default(MONTHLY)
  customLimits           Json?
  responsesUsedThisMonth Int                   @default(0)
  monthlyResetDate       DateTime              @default(now())
  address                String?
  city                   String?
  country                String                @default("IT")
  postalCode             String?
  vatId                  String?
  crossChannelInsights   CrossChannelInsight[]
  members                Membership[]
  projects               Project[]
  subscription           Subscription?
  tokenUsage             TokenUsage?
  usageLogs              UsageLog[]
  visibilityConfig       VisibilityConfig?
  strategicVision        String?
  valueProposition       String?
}

model Subscription {
  id                      String             @id @default(cuid())
  organizationId          String             @unique
  tier                    SubscriptionTier   @default(FREE)
  status                  SubscriptionStatus @default(ACTIVE)
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  stripePriceId           String?
  maxActiveBots           Int                @default(1)
  maxInterviewsPerMonth   Int                @default(30)
  maxUsers                Int                @default(1)
  currentPeriodStart      DateTime           @default(now())
  currentPeriodEnd        DateTime
  interviewsUsedThisMonth Int                @default(0)
  billingEmail            String?
  billingName             String?
  vatNumber               String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  canceledAt              DateTime?
  codiceFiscale           String?
  pecEmail                String?
  sdiCode                 String?
  invoices                Invoice[]
  organization            Organization       @relation(fields: [organizationId], references: [id])
}

model Invoice {
  id              String       @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String       @unique
  amountPaid      Int
  currency        String       @default("eur")
  status          String
  pdfUrl          String?
  createdAt       DateTime     @default(now())
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])
}

model UsageEvent {
  id             String         @id @default(cuid())
  organizationId String
  eventType      UsageEventType
  resourceId     String?
  metadata       Json?
  createdAt      DateTime       @default(now())

  @@index([organizationId, createdAt])
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           Role         @default(MEMBER)
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Project {
  id             String          @id @default(cuid())
  name           String
  organizationId String?
  ownerId        String?
  isPersonal     Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bots           Bot[]
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  owner          User?           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  accessList     ProjectAccess[]
  visibilityConfigs VisibilityConfig[]
}

model Bot {
  id                    String               @id @default(cuid())
  projectId             String
  slug                  String               @unique
  name                  String
  description           String?
  status                BotStatus            @default(DRAFT)
  researchGoal          String?
  targetAudience        String?
  language              String               @default("en")
  tone                  String?
  introMessage          String?
  maxDurationMins       Int                  @default(10)
  maxTurns              Int                  @default(20)
  maxOpenQuestions      Int                  @default(5)
  modelProvider         String               @default("openai")
  modelName             String               @default("gpt-4o")
  openaiApiKey          String?
  anthropicApiKey       String?
  logoUrl               String?
  primaryColor          String               @default("#6366f1")
  backgroundColor       String               @default("#ffffff")
  textColor             String               @default("#1f2937")
  anonymizationLevel    String               @default("partial")
  privacyNotice         String?
  dataUsageInfo         String?
  consentText           String?
  privacyPolicyUrl      String?
  showAnonymityInfo     Boolean              @default(true)
  showDataUsageInfo     Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  analyticsMetadata     Json?
  formatExplanation     String?
  progressBarStyle      String               @default("semantic")
  showProgressBar       Boolean              @default(true)
  showTopicPreview      Boolean              @default(false)
  welcomeSubtitle       String?
  welcomeTitle          String?
  warmupChoices         Json?
  warmupContextPrompt   String?
  warmupFollowup        Boolean              @default(true)
  warmupIcebreaker      String?
  warmupStyle           String               @default("open")
  useWarmup             Boolean              @default(true)
  landingDescription    String?
  landingImageUrl       String?
  landingTitle          String?
  landingVideoUrl       String?
  candidateDataFields   Json?
  collectCandidateData  Boolean              @default(false)
  allowedDomains        Json?
  botType               String               @default("interview")
  bubbleAnimation       String               @default("bounce")
  bubbleIcon            String?
  bubblePosition        String               @default("bottom-right")
  bubbleSize            String               @default("medium")
  enablePageContext     Boolean              @default(true)
  fallbackMessage       String?
  leadCaptureMessage    String?
  leadCaptureStrategy   String               @default("after_3_msgs")
  maxMessagesPerSession Int                  @default(20)
  maxTokensPerMessage   Int                  @default(500)
  webhookUrl            String?
  project               Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics             ChatbotAnalytics[]
  chatbotSessions       ChatbotSession[]
  conversations         Conversation[]
  faqSuggestions        FaqSuggestion[]
  hotIdeas              HotIdea[]
  insights              Insight[]
  knowledgeGaps         KnowledgeGap[]
  knowledgeSources      KnowledgeSource[]
  questionDefinitions   QuestionDefinition[]
  reports               Report[]
  rewardConfig          RewardConfig?
  themes                Theme[]
  topics                TopicBlock[]
}

model KnowledgeSource {
  id        String   @id @default(cuid())
  botId     String
  type      String
  title     String?
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model TopicBlock {
  id          String   @id @default(cuid())
  botId       String
  orderIndex  Int
  label       String
  description String?
  subGoals    String[]
  maxTurns    Int      @default(5)
  keywords    Json?
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, orderIndex])
}

model RewardConfig {
  id            String  @id @default(cuid())
  botId         String  @unique
  enabled       Boolean @default(false)
  type          String
  payload       String
  displayText   String?
  showOnLanding Boolean @default(true)
  bot           Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Conversation {
  id                String                @id @default(cuid())
  botId             String
  participantId     String
  status            String
  fatigueScore      Int                   @default(0)
  currentTopicId    String?
  startedAt         DateTime              @default(now())
  completedAt       DateTime?
  durationSeconds   Int?
  effectiveDuration Int                   @default(0)
  sentimentScore    Float?
  tags              String[]
  exchangeCount     Int                   @default(0)
  totalTokens       Int                   @default(0)
  metadata          Json?
  candidateProfile  Json?
  chatbotSession    ChatbotSession?
  bot               Bot                   @relation(fields: [botId], references: [id], onDelete: Cascade)
  analysis          ConversationAnalysis?
  memory            ConversationMemory?
  messages          Message[]
  rewardGrant       RewardGrant?
  answers           StructuredAnswer[]
  themeOccurrences  ThemeOccurrence[]
}

model ConversationMemory {
  id                String       @id @default(cuid())
  conversationId    String       @unique
  factsCollected    Json         @default("[]")
  topicsExplored    Json         @default("[]")
  unansweredAreas   Json         @default("[]")
  userFatigueScore  Float        @default(0)
  detectedTone      String?
  avgResponseLength Int          @default(0)
  usesEmoji         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationAnalysis {
  id             String       @id @default(cuid())
  conversationId String       @unique
  topicCoverage  Float
  sentimentScore Float
  keyQuotes      Json
  metadata       Json?
  themes         Json?
  sentiment      Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  metadata       Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model RewardGrant {
  id             String       @id @default(cuid())
  conversationId String       @unique
  userId         String?
  code           String?
  claimedAt      DateTime     @default(now())
  guestEmail     String?
  guestName      String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])
}

model QuestionDefinition {
  id      String             @id @default(cuid())
  botId   String
  type    String
  text    String
  options Json?
  bot     Bot                @relation(fields: [botId], references: [id], onDelete: Cascade)
  answers StructuredAnswer[]
}

model StructuredAnswer {
  id             String             @id @default(cuid())
  conversationId String
  questionId     String
  value          String
  conversation   Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  question       QuestionDefinition @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Theme {
  id          String            @id @default(cuid())
  botId       String
  name        String
  category    String?
  description String?
  bot         Bot               @relation(fields: [botId], references: [id], onDelete: Cascade)
  occurrences ThemeOccurrence[]
}

model ThemeOccurrence {
  id             String       @id @default(cuid())
  themeId        String
  conversationId String
  strengthScore  Float
  snippet        String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  theme          Theme        @relation(fields: [themeId], references: [id], onDelete: Cascade)
}

model Insight {
  id        String @id @default(cuid())
  botId     String
  type      String @default("STRATEGIC")
  content   String
  citations Json?
  bot       Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model HotIdea {
  id      String @id @default(cuid())
  botId   String
  content String
  bot     Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Report {
  id        String   @id @default(cuid())
  botId     String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MetricSummary {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  organizationId String
  type           UsageType
  count          Int          @default(1)
  tokensInput    Int?
  tokensOutput   Int?
  model          String?
  task           String?
  resourceId     String?
  metadata       Json?
  timestamp      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([organizationId, type, timestamp])
}

model ChatbotSession {
  id              String       @id @default(cuid())
  botId           String
  conversationId  String       @unique
  pageUrl         String
  pageTitle       String?
  pageDescription String?
  pageContent     String?
  sessionId       String
  userAgent       String?
  referrer        String?
  tokensUsed      Int          @default(0)
  messagesCount   Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  bot             Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([botId, sessionId])
  @@index([botId, createdAt])
}

model TokenUsage {
  id              String       @id @default(cuid())
  organizationId  String       @unique
  periodStart     DateTime     @default(now())
  periodEnd       DateTime
  usedTokens      Int          @default(0)
  purchasedTokens Int          @default(0)
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id])
}

model ChatbotAnalytics {
  id               String   @id @default(cuid())
  botId            String
  period           String
  sessionsCount    Int
  messagesCount    Int
  avgSessionLength Float
  leadsCollected   Int
  bounceRate       Float
  questionClusters Json
  knowledgeGaps    Json
  sentiment        Json
  createdAt        DateTime @default(now())
  bot              Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, period])
}

model KnowledgeGap {
  id           String    @id @default(cuid())
  botId        String
  topic        String
  priority     String
  evidence     Json
  suggestedFaq Json?
  status       String    @default("pending")
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bot          Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model FaqSuggestion {
  id          String   @id @default(cuid())
  botId       String
  question    String
  answer      String
  confidence  Float
  occurrences Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model CrossChannelInsight {
  id                String       @id @default(cuid())
  organizationId    String
  topicName         String
  interviewData     Json?
  chatbotData       Json?
  visibilityData    Json?
  crossChannelScore Float
  priorityScore     Float
  suggestedActions  Json
  status            String       @default("new")
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, priorityScore])
}

model VisibilityConfig {
  id             String   @id @default(cuid())
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  brandName      String
  category       String
  description    String?
  language       String   @default("it")
  territory      String   @default("IT")
  
  isActive       Boolean  @default(true)
  nextScanAt     DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  prompts        VisibilityPrompt[]
  competitors    Competitor[]
  scans          VisibilityScan[]
  serpScans      SerpMonitoringScan[]
}

model VisibilityPrompt {
  id                String           @id @default(cuid())
  configId          String?
  visibilityConfig  VisibilityConfig? @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  text              String
  enabled           Boolean          @default(true)
  orderIndex        Int              @default(0)
  generatedByAI     Boolean          @default(false)
  lastEditedAt      DateTime         @default(now())
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  responses         VisibilityResponse[]
}

model Competitor {
  id                String           @id @default(cuid())
  configId          String
  visibilityConfig  VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  name              String
  website           String?
  enabled           Boolean          @default(true)
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model VisibilityScan {
  id                String           @id @default(cuid())
  configId          String
  visibilityConfig  VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  scanType          String           @default("manual") // manual, scheduled
  score             Float            @default(0)
  startedAt         DateTime         @default(now())
  completedAt       DateTime?
  status            String           @default("pending")
  
  metrics           VisibilityScanMetric[]
  responses         VisibilityResponse[]
}

model VisibilityResponse {
  id                  String           @id @default(cuid())
  scanId              String
  promptId            String
  platform            String
  model               String
  responseText        String           @db.Text
  brandMentioned      Boolean
  brandPosition       Int?
  competitorPositions Json
  sentiment           String?
  sourcesCited        String[]
  tokenUsage          Json?
  createdAt           DateTime         @default(now())
  
  scan                VisibilityScan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  prompt              VisibilityPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
}

model VisibilityScanMetric {
  id              String         @id @default(cuid())
  scanId          String
  scan            VisibilityScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  metricType      String
  value           Float
  dimensions      Json?
}

// SERP Monitoring - Google Search Results for Brand Mentions
model SerpMonitoringScan {
  id              String           @id @default(cuid())
  configId        String
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  scanType        String           @default("manual") // manual, scheduled, weekly
  query           String           // Search query used (brand name + filters)
  dateRange       String           @default("last_week") // last_week, last_month, last_day
  totalResults    Int              @default(0)

  // Aggregate metrics
  positiveCount   Int              @default(0)
  negativeCount   Int              @default(0)
  neutralCount    Int              @default(0)
  avgImportance   Float            @default(0)

  startedAt       DateTime         @default(now())
  completedAt     DateTime?
  status          String           @default("pending") // pending, running, completed, failed

  results         SerpResult[]

  @@index([configId, startedAt])
}

model SerpResult {
  id              String           @id @default(cuid())
  scanId          String
  scan            SerpMonitoringScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Raw SERP data
  title           String
  url             String
  snippet         String           @db.Text
  displayedLink   String?
  publishedDate   DateTime?
  position        Int              // Position in search results

  // Source analysis
  sourceDomain    String           // e.g., "ilsole24ore.com"
  sourceType      String           // news, blog, forum, social, corporate, government
  sourceReputation Float           @default(50) // 0-100 reputation score

  // AI Analysis
  sentiment       String           // positive, negative, neutral, mixed
  sentimentScore  Float            // -1 to 1 continuous score
  relevanceScore  Float            // 0-100 how relevant to brand
  importanceScore Float            // 0-100 overall importance (combines all factors)

  // Content analysis
  brandMentionType String          // direct, indirect, competitor_comparison, industry_mention
  topicCategory   String?          // product, service, leadership, controversy, award, partnership
  keyEntities     Json?            // People, companies, products mentioned
  contentSummary  String?          @db.Text // AI-generated summary

  // Cross-channel correlation
  relatedToLLMVisibility Boolean   @default(false) // Does this affect LLM recommendations?
  suggestedActions Json?           // AI-suggested responses/actions

  // Status
  isReviewed      Boolean          @default(false)
  reviewedBy      String?
  reviewedAt      DateTime?
  flagged         Boolean          @default(false) // Manual flag for attention

  createdAt       DateTime         @default(now())

  @@index([scanId, importanceScore])
  @@index([scanId, sentiment])
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
  USER
}

enum PlanType {
  TRIAL
  STARTER
  PRO
  BUSINESS
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum UsageEventType {
  INTERVIEW_COMPLETED
  BOT_PUBLISHED
  BOT_UNPUBLISHED
  USER_INVITED
}

enum UsageType {
  RESPONSE_COMPLETED
  SIMULATION
  AI_REGENERATION
  API_CALL
  TOKEN_USAGE
}

enum ResponseStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  LIMIT_REACHED
}

enum BotStatus {
  DRAFT
  PUBLISHED
  PAUSED
  ARCHIVED
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}
