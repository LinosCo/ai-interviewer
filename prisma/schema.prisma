generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String               @id @default(cuid())
  name                    String?
  email                   String               @unique
  emailVerified           DateTime?
  password                String?
  image                   String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  platformOpenaiApiKey    String?
  platformAnthropicApiKey String?
  role                    UserRole             @default(USER)
  customApiKeys           Json?
  accounts                Account[]
  memberships             Membership[]
  passwordResetTokens     PasswordResetToken[]
  platformSettings        PlatformSettings?
  ownedProjects           Project[]
  projectAccess           ProjectAccess[]
  reports                 Report[]
  rewardGrants            RewardGrant[]
  sessions                Session[]
}

model ProjectAccess {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

enum ProjectRole {
  OWNER
  MEMBER
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PlatformSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  methodologyKnowledge String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GlobalConfig {
  id                       String   @id @default("default")
  openaiApiKey             String?
  anthropicApiKey          String?
  geminiApiKey             String?
  googleSerpApiKey         String?
  stripeSecretKey          String?
  stripeWebhookSecret      String?
  stripePriceStarter       String?
  stripePricePro           String?
  stripePriceBusiness      String?
  updatedAt                DateTime @updatedAt
  stripePriceProYearly     String?
  stripePriceStarterYearly String?
}

model Organization {
  id                     String                @id @default(cuid())
  name                   String
  slug                   String                @unique
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  allowCustomApiKeys     Boolean               @default(false)
  plan                   PlanType              @default(TRIAL)
  billingCycle           BillingCycle          @default(MONTHLY)
  customLimits           Json?
  responsesUsedThisMonth Int                   @default(0)
  monthlyResetDate       DateTime              @default(now())
  address                String?
  city                   String?
  country                String                @default("IT")
  postalCode             String?
  vatId                  String?
  crossChannelInsights   CrossChannelInsight[]
  members                Membership[]
  projects               Project[]
  subscription           Subscription?
  tokenLogs              TokenLog[]
  tokenUsage             TokenUsage?
  usageLogs              UsageLog[]
  visibilityConfigs      VisibilityConfig[]
  strategicVision        String?
  valueProposition       String?

  // CMS Integration (managed by Voler.ai admin)
  hasCMSIntegration      Boolean               @default(false)
  cmsConnection          CMSConnection?
}

model Subscription {
  id                String   @id @default(cuid())
  organizationId    String   @unique
  
  // Tier e stato
  tier              SubscriptionTier @default(TRIAL)
  status            SubscriptionStatus @default(TRIALING)
  isPartner         Boolean  @default(false)
  
  // Stripe IDs
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique
  stripePriceId         String?
  
  // ═══════════════════════════════════════════════════════════
  // CONTATORI UTILIZZO MENSILE (resettati ogni mese)
  // ═══════════════════════════════════════════════════════════
  tokensUsedThisMonth           Int @default(0)
  interviewsUsedThisMonth       Int @default(0)
  chatbotSessionsUsedThisMonth  Int @default(0)
  visibilityQueriesUsedThisMonth Int @default(0)
  aiSuggestionsUsedThisMonth    Int @default(0)
  
  // Breakdown token per categoria
  interviewTokensUsed    Int @default(0)
  chatbotTokensUsed      Int @default(0)
  visibilityTokensUsed   Int @default(0)
  suggestionTokensUsed   Int @default(0)
  systemTokensUsed       Int @default(0)
  
  // ═══════════════════════════════════════════════════════════
  // RISORSE EXTRA DA ADD-ON (sommate ai limiti piano)
  // ═══════════════════════════════════════════════════════════
  extraTokens            Int @default(0)
  extraInterviews        Int @default(0)
  extraChatbotSessions   Int @default(0)
  extraVisibilityQueries Int @default(0)
  extraAiSuggestions     Int @default(0)
  extraUsers             Int @default(0)
  
  // ═══════════════════════════════════════════════════════════
  // PERIODO E TRIAL
  // ═══════════════════════════════════════════════════════════
  currentPeriodStart  DateTime @default(now())
  currentPeriodEnd    DateTime?
  trialEndsAt         DateTime?
  canceledAt          DateTime?
  cancelAtPeriodEnd   Boolean  @default(false)
  
  // ═══════════════════════════════════════════════════════════
  // FATTURAZIONE ITALIANA
  // ═══════════════════════════════════════════════════════════
  billingName         String?
  billingEmail        String?
  vatNumber           String?   // Partita IVA
  codiceFiscale       String?
  sdiCode             String?   // Codice SDI
  pecEmail            String?   // PEC
  billingAddress      Json?     // { street, city, zip, province, country }
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchasedAddOns     PurchasedAddOn[]
  invoices            Invoice[]
  
  customLimits        Json?     // Admin-overridable limits
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Invoice {
  id              String       @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String       @unique
  amountPaid      Int
  currency        String       @default("eur")
  status          String
  pdfUrl          String?
  createdAt       DateTime     @default(now())
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])
}

model UsageEvent {
  id             String         @id @default(cuid())
  organizationId String
  eventType      UsageEventType
  resourceId     String?
  metadata       Json?
  createdAt      DateTime       @default(now())

  @@index([organizationId, createdAt])
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           Role         @default(MEMBER)
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Project {
  id             String          @id @default(cuid())
  name           String
  organizationId String?
  ownerId        String?
  isPersonal     Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bots           Bot[]
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  owner          User?           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  accessList     ProjectAccess[]
  visibilityConfigs VisibilityConfig[]
}

model Bot {
  id                    String               @id @default(cuid())
  projectId             String
  slug                  String               @unique
  name                  String
  description           String?
  status                BotStatus            @default(DRAFT)
  researchGoal          String?
  targetAudience        String?
  language              String               @default("en")
  tone                  String?
  introMessage          String?
  maxDurationMins       Int                  @default(10)
  maxTurns              Int                  @default(20)
  maxOpenQuestions      Int                  @default(5)
  modelProvider         String               @default("openai")
  modelName             String               @default("gpt-4o")
  openaiApiKey          String?
  anthropicApiKey       String?
  logoUrl               String?
  primaryColor          String               @default("#6366f1")
  backgroundColor       String               @default("#ffffff")
  textColor             String               @default("#1f2937")
  anonymizationLevel    String               @default("partial")
  privacyNotice         String?
  dataUsageInfo         String?
  consentText           String?
  privacyPolicyUrl      String?
  showAnonymityInfo     Boolean              @default(true)
  showDataUsageInfo     Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  boundaries            Json?
  analyticsMetadata     Json?
  formatExplanation     String?
  progressBarStyle      String               @default("semantic")
  showProgressBar       Boolean              @default(true)
  showTopicPreview      Boolean              @default(false)
  welcomeSubtitle       String?
  welcomeTitle          String?
  warmupChoices         Json?
  warmupContextPrompt   String?
  warmupFollowup        Boolean              @default(true)
  warmupIcebreaker      String?
  warmupStyle           String               @default("open")
  useWarmup             Boolean              @default(true)
  landingDescription    String?
  landingImageUrl       String?
  landingTitle          String?
  landingVideoUrl       String?
  candidateDataFields   Json?
  collectCandidateData  Boolean              @default(false)
  allowedDomains        Json?
  botType               String               @default("interview")
  bubbleAnimation       String               @default("bounce")
  bubbleIcon            String?
  bubblePosition        String               @default("bottom-right")
  bubbleSize            String               @default("medium")
  enablePageContext     Boolean              @default(true)
  fallbackMessage       String?
  leadCaptureMessage    String?
  leadCaptureStrategy   String               @default("after_3_msgs")
  maxMessagesPerSession Int                  @default(20)
  maxTokensPerMessage   Int                  @default(500)
  webhookUrl            String?
  project               Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics             ChatbotAnalytics[]
  chatbotSessions       ChatbotSession[]
  conversations         Conversation[]
  faqSuggestions        FaqSuggestion[]
  hotIdeas              HotIdea[]
  insights              Insight[]
  knowledgeGaps         KnowledgeGap[]
  knowledgeSources      KnowledgeSource[]
  questionDefinitions   QuestionDefinition[]
  reports               Report[]
  rewardConfig          RewardConfig?
  themes                Theme[]
  topics                TopicBlock[]
}

model KnowledgeSource {
  id        String   @id @default(cuid())
  botId     String
  type      String
  title     String?
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model TopicBlock {
  id          String   @id @default(cuid())
  botId       String
  orderIndex  Int
  label       String
  description String?
  subGoals    String[]
  maxTurns    Int      @default(5)
  keywords    Json?
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, orderIndex])
}

model RewardConfig {
  id            String  @id @default(cuid())
  botId         String  @unique
  enabled       Boolean @default(false)
  type          String
  payload       String
  displayText   String?
  showOnLanding Boolean @default(true)
  bot           Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Conversation {
  id                String                @id @default(cuid())
  botId             String
  participantId     String
  status            String
  fatigueScore      Int                   @default(0)
  currentTopicId    String?
  startedAt         DateTime              @default(now())
  completedAt       DateTime?
  durationSeconds   Int?
  effectiveDuration Int                   @default(0)
  sentimentScore    Float?
  tags              String[]
  exchangeCount     Int                   @default(0)
  totalTokens       Int                   @default(0)
  metadata          Json?
  candidateProfile  Json?
  chatbotSession    ChatbotSession?
  bot               Bot                   @relation(fields: [botId], references: [id], onDelete: Cascade)
  analysis          ConversationAnalysis?
  memory            ConversationMemory?
  messages          Message[]
  rewardGrant       RewardGrant?
  answers           StructuredAnswer[]
  themeOccurrences  ThemeOccurrence[]
}

model ConversationMemory {
  id                String       @id @default(cuid())
  conversationId    String       @unique
  factsCollected    Json         @default("[]")
  topicsExplored    Json         @default("[]")
  unansweredAreas   Json         @default("[]")
  userFatigueScore  Float        @default(0)
  detectedTone      String?
  avgResponseLength Int          @default(0)
  usesEmoji         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationAnalysis {
  id             String       @id @default(cuid())
  conversationId String       @unique
  topicCoverage  Float
  sentimentScore Float
  keyQuotes      Json
  metadata       Json?
  themes         Json?
  sentiment      Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  metadata       Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model RewardGrant {
  id             String       @id @default(cuid())
  conversationId String       @unique
  userId         String?
  code           String?
  claimedAt      DateTime     @default(now())
  guestEmail     String?
  guestName      String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id])
}

model QuestionDefinition {
  id      String             @id @default(cuid())
  botId   String
  type    String
  text    String
  options Json?
  bot     Bot                @relation(fields: [botId], references: [id], onDelete: Cascade)
  answers StructuredAnswer[]
}

model StructuredAnswer {
  id             String             @id @default(cuid())
  conversationId String
  questionId     String
  value          String
  conversation   Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  question       QuestionDefinition @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Theme {
  id          String            @id @default(cuid())
  botId       String
  name        String
  category    String?
  description String?
  bot         Bot               @relation(fields: [botId], references: [id], onDelete: Cascade)
  occurrences ThemeOccurrence[]
}

model ThemeOccurrence {
  id             String       @id @default(cuid())
  themeId        String
  conversationId String
  strengthScore  Float
  snippet        String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  theme          Theme        @relation(fields: [themeId], references: [id], onDelete: Cascade)
}

model Insight {
  id        String @id @default(cuid())
  botId     String
  type      String @default("STRATEGIC")
  content   String
  citations Json?
  bot       Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model HotIdea {
  id      String @id @default(cuid())
  botId   String
  content String
  bot     Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model Report {
  id        String   @id @default(cuid())
  botId     String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MetricSummary {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
}

model UsageLog {
  id             String       @id @default(cuid())
  organizationId String
  type           UsageType
  count          Int          @default(1)
  tokensInput    Int?
  tokensOutput   Int?
  model          String?
  task           String?
  resourceId     String?
  metadata       Json?
  timestamp      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, timestamp])
  @@index([organizationId, type, timestamp])
}

model ChatbotSession {
  id              String       @id @default(cuid())
  botId           String
  conversationId  String       @unique
  pageUrl         String
  pageTitle       String?
  pageDescription String?
  pageContent     String?
  sessionId       String
  userAgent       String?
  referrer        String?
  tokensUsed      Int          @default(0)
  messagesCount   Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  bot             Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([botId, sessionId])
  @@index([botId, createdAt])
}

model TokenUsage {
  id              String       @id @default(cuid())
  organizationId  String       @unique
  periodStart     DateTime     @default(now())
  periodEnd       DateTime
  usedTokens      Int          @default(0)
  purchasedTokens Int          @default(0)
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id])

  // Breakdown per categoria
  interviewTokens    Int       @default(0)
  chatbotTokens      Int       @default(0)
  visibilityTokens   Int       @default(0)
  suggestionTokens   Int       @default(0)
  systemTokens       Int       @default(0)

  // Contatori risorse
  interviewsUsed        Int    @default(0)
  chatbotSessionsUsed   Int    @default(0)
  visibilityQueriesUsed Int    @default(0)
  aiSuggestionsUsed     Int    @default(0)
}

// ═══════════════════════════════════════════════════════════════
// TOKEN LOG MODEL - Per tracking dettagliato
// ═══════════════════════════════════════════════════════════════

model TokenLog {
  id              String   @id @default(cuid())
  organizationId  String
  userId          String?
  
  // Categorizzazione
  category        TokenCategory
  operation       String    // es: "interview_response", "chatbot_message", "visibility_scan"
  
  // Conteggio token
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  
  // Riferimenti
  resourceType    String?   // es: "interview", "chatbot", "visibility"
  resourceId      String?   // ID della risorsa specifica
  
  // Modello usato
  model           String    // es: "gpt-4o-mini", "claude-sonnet"
  
  // Flag source
  usedExtraTokens Boolean   @default(false)
  addOnId         String?   // Se usato da add-on specifico
  
  createdAt       DateTime  @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, createdAt])
  @@index([organizationId, category])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════
// PURCHASED ADD-ON MODEL - Nuovo
// ═══════════════════════════════════════════════════════════════

model PurchasedAddOn {
  id              String   @id @default(cuid())
  subscriptionId  String
  
  // Tipo e quantità
  type            AddOnType
  stripeProductId String?
  stripePriceId   String?
  stripePaymentIntentId String?
  
  // Quantità
  quantity        Int      // Quantità acquistata
  remaining       Int      // Quantità rimanente (decrementata ad ogni uso)
  
  // Prezzo pagato
  amountPaid      Int      // In centesimi
  currency        String   @default("eur")
  
  // Validità
  purchasedAt     DateTime @default(now())
  expiresAt       DateTime?  // Null = non scade, altrimenti fine periodo
  isActive        Boolean  @default(true)
  
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([subscriptionId, type, isActive])
}

enum TokenCategory {
  INTERVIEW
  CHATBOT
  VISIBILITY
  SUGGESTION
  SYSTEM
}

enum AddOnType {
  TOKENS
  INTERVIEWS
  CHATBOT_SESSIONS
  VISIBILITY_QUERIES
  AI_SUGGESTIONS
  EXTRA_USERS
}

model ChatbotAnalytics {
  id               String   @id @default(cuid())
  botId            String
  period           String
  sessionsCount    Int
  messagesCount    Int
  avgSessionLength Float
  leadsCollected   Int
  bounceRate       Float
  questionClusters Json
  knowledgeGaps    Json
  sentiment        Json
  createdAt        DateTime @default(now())
  bot              Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, period])
}

model KnowledgeGap {
  id           String    @id @default(cuid())
  botId        String
  topic        String
  priority     String
  evidence     Json
  suggestedFaq Json?
  status       String    @default("pending")
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bot          Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model FaqSuggestion {
  id          String   @id @default(cuid())
  botId       String
  question    String
  answer      String
  confidence  Float
  occurrences Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model CrossChannelInsight {
  id                String       @id @default(cuid())
  organizationId    String
  topicName         String
  interviewData     Json?
  chatbotData       Json?
  visibilityData    Json?
  crossChannelScore Float
  priorityScore     Float
  suggestedActions  Json
  status            String       @default("new")
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, priorityScore])
}

model VisibilityConfig {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  brandName      String
  category       String
  description    String?
  language       String   @default("it")
  territory      String   @default("IT")
  
  isActive       Boolean  @default(true)
  nextScanAt     DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  prompts        VisibilityPrompt[]
  competitors    Competitor[]
  scans          VisibilityScan[]
  serpScans      SerpMonitoringScan[]
}

model VisibilityPrompt {
  id                String           @id @default(cuid())
  configId          String?
  visibilityConfig  VisibilityConfig? @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  text              String
  enabled           Boolean          @default(true)
  orderIndex        Int              @default(0)
  generatedByAI     Boolean          @default(false)
  lastEditedAt      DateTime         @default(now())
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  responses         VisibilityResponse[]
}

model Competitor {
  id                String           @id @default(cuid())
  configId          String
  visibilityConfig  VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  name              String
  website           String?
  enabled           Boolean          @default(true)
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model VisibilityScan {
  id                String           @id @default(cuid())
  configId          String
  visibilityConfig  VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  scanType          String           @default("manual") // manual, scheduled
  score             Float            @default(0)
  startedAt         DateTime         @default(now())
  completedAt       DateTime?
  status            String           @default("pending")
  
  metrics           VisibilityScanMetric[]
  responses         VisibilityResponse[]
}

model VisibilityResponse {
  id                  String           @id @default(cuid())
  scanId              String
  promptId            String
  platform            String
  model               String
  responseText        String           @db.Text
  brandMentioned      Boolean
  brandPosition       Int?
  competitorPositions Json
  sentiment           String?
  sourcesCited        String[]
  tokenUsage          Json?
  createdAt           DateTime         @default(now())
  
  scan                VisibilityScan   @relation(fields: [scanId], references: [id], onDelete: Cascade)
  prompt              VisibilityPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
}

model VisibilityScanMetric {
  id              String         @id @default(cuid())
  scanId          String
  scan            VisibilityScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  metricType      String
  value           Float
  dimensions      Json?
}

// SERP Monitoring - Google Search Results for Brand Mentions
model SerpMonitoringScan {
  id              String           @id @default(cuid())
  configId        String
  visibilityConfig VisibilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  scanType        String           @default("manual") // manual, scheduled, weekly
  query           String           // Search query used (brand name + filters)
  dateRange       String           @default("last_week") // last_week, last_month, last_day
  totalResults    Int              @default(0)

  // Aggregate metrics
  positiveCount   Int              @default(0)
  negativeCount   Int              @default(0)
  neutralCount    Int              @default(0)
  avgImportance   Float            @default(0)

  startedAt       DateTime         @default(now())
  completedAt     DateTime?
  status          String           @default("pending") // pending, running, completed, failed

  results         SerpResult[]

  @@index([configId, startedAt])
}

model SerpResult {
  id              String           @id @default(cuid())
  scanId          String
  scan            SerpMonitoringScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Raw SERP data
  title           String
  url             String
  snippet         String           @db.Text
  displayedLink   String?
  publishedDate   DateTime?
  position        Int              // Position in search results

  // Source analysis
  sourceDomain    String           // e.g., "ilsole24ore.com"
  sourceType      String           // news, blog, forum, social, corporate, government
  sourceReputation Float           @default(50) // 0-100 reputation score

  // AI Analysis
  sentiment       String           // positive, negative, neutral, mixed
  sentimentScore  Float            // -1 to 1 continuous score
  relevanceScore  Float            // 0-100 how relevant to brand
  importanceScore Float            // 0-100 overall importance (combines all factors)

  // Content analysis
  brandMentionType String          // direct, indirect, competitor_comparison, industry_mention
  topicCategory   String?          // product, service, leadership, controversy, award, partnership
  keyEntities     Json?            // People, companies, products mentioned
  contentSummary  String?          @db.Text // AI-generated summary

  // Cross-channel correlation
  relatedToLLMVisibility Boolean   @default(false) // Does this affect LLM recommendations?
  suggestedActions Json?           // AI-suggested responses/actions

  // Status
  isReviewed      Boolean          @default(false)
  reviewedBy      String?
  reviewedAt      DateTime?
  flagged         Boolean          @default(false) // Manual flag for attention

  createdAt       DateTime         @default(now())

  @@index([scanId, importanceScore])
  @@index([scanId, sentiment])
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
  USER
}

enum PlanType {
  TRIAL
  STARTER
  PRO
  BUSINESS
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionTier {
  FREE
  TRIAL
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
  PARTNER
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum UsageEventType {
  INTERVIEW_COMPLETED
  BOT_PUBLISHED
  BOT_UNPUBLISHED
  USER_INVITED
}

enum UsageType {
  RESPONSE_COMPLETED
  SIMULATION
  AI_REGENERATION
  API_CALL
  TOKEN_USAGE
}

enum ResponseStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  LIMIT_REACHED
}

enum BotStatus {
  DRAFT
  PUBLISHED
  PAUSED
  ARCHIVED
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ═══════════════════════════════════════════════════════════════════════════
// CMS INTEGRATION MODELS
// ═══════════════════════════════════════════════════════════════════════════

model CMSConnection {
  id              String              @id @default(cuid())
  organizationId  String              @unique
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Base configuration (set by admin)
  name            String              // Display name: "Sito Aziendale"
  cmsApiUrl       String              // "https://cms.cliente.it/api/integration"
  cmsDashboardUrl String?             // "https://cms.cliente.it/dashboard"
  cmsPublicUrl    String?             // "https://www.cliente.it"

  // Authentication (BT -> CMS)
  apiKey          String              // Encrypted, generated by BT
  apiKeyPrefix    String              // "bt_live_" or "bt_test_" (not encrypted, for display)
  apiKeyLastChars String              // Last 4 characters (for display: "...x7k2")

  // Webhook (CMS -> BT)
  webhookSecret   String              // Encrypted, for verifying signature
  webhookUrl      String              // Callback URL on BT

  // Google Integration (managed by BT)
  googleAnalyticsPropertyId   String? // "properties/123456789"
  googleAnalyticsConnected    Boolean @default(false)
  searchConsoleSiteUrl        String? // "https://www.cliente.it/"
  searchConsoleConnected      Boolean @default(false)
  googleRefreshToken          String? // Encrypted
  googleTokenExpiresAt        DateTime?
  googleScopes                String[]

  // Status
  status          CMSConnectionStatus @default(PENDING)
  lastPingAt      DateTime?           // Last successful health check
  lastSyncAt      DateTime?           // Last analytics sync
  lastSyncError   String?
  capabilities    String[]            // Capabilities reported by CMS
  cmsVersion      String?             // CMS version

  // Branding sync
  brandingSyncEnabled Boolean         @default(true)
  lastBrandingSyncAt  DateTime?

  // Audit
  notes           String?             // Internal admin notes
  enabledAt       DateTime            @default(now())
  enabledBy       String              // Email of admin who enabled

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  suggestions     CMSSuggestion[]
  analytics       WebsiteAnalytics[]
  webhookLogs     CMSWebhookLog[]
}

enum CMSConnectionStatus {
  PENDING         // Created but never tested
  ACTIVE          // Working
  PARTIAL         // CMS ok, Google partial
  GOOGLE_ONLY     // Google ok, CMS unreachable
  ERROR           // Last test failed
  DISABLED        // Manually disabled
}

model CMSWebhookLog {
  id              String           @id @default(cuid())
  connectionId    String
  connection      CMSConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  direction       WebhookDirection // INBOUND (CMS->BT) or OUTBOUND (BT->CMS)
  event           String           // "content.published", "suggestion.push", etc.
  requestPayload  Json?
  responseStatus  Int?
  responseBody    String?
  success         Boolean
  errorMessage    String?

  createdAt       DateTime         @default(now())

  @@index([connectionId, createdAt])
}

enum WebhookDirection {
  INBOUND         // CMS -> Business Tuner
  OUTBOUND        // Business Tuner -> CMS
}

model CMSSuggestion {
  id              String              @id @default(cuid())
  connectionId    String
  connection      CMSConnection       @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Source insight (optional link to Cross-Channel)
  crossChannelInsightId  String?

  // Content suggestion
  type            CMSSuggestionType
  title           String
  slug            String?             // Suggested URL slug
  body            String              @db.Text
  metaDescription String?
  targetSection   String?             // "blog", "faq", "pages", etc.

  // AI reasoning
  reasoning       String              @db.Text
  sourceSignals   Json                // { chatbotQuestions: 34, visibilityGap: true, ... }
  priorityScore   Int                 @default(50) // 0-100

  // Status tracking
  status          CMSSuggestionStatus @default(PENDING)

  // CMS response (after push)
  cmsContentId    String?             // ID returned by CMS
  cmsPreviewUrl   String?             // Preview URL on the site

  // Timestamps
  pushedAt        DateTime?
  publishedAt     DateTime?           // When detected as live
  rejectedAt      DateTime?
  rejectedReason  String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([connectionId, status])
  @@index([connectionId, createdAt])
}

enum CMSSuggestionType {
  CREATE_PAGE
  CREATE_FAQ
  CREATE_BLOG_POST
  MODIFY_CONTENT
  ADD_SECTION
}

enum CMSSuggestionStatus {
  PENDING         // Generated, not yet sent
  PUSHED          // Sent to CMS as draft
  PUBLISHED       // Detected as live on site
  REJECTED        // User rejected
  FAILED          // Push failed
}

model WebsiteAnalytics {
  id              String           @id @default(cuid())
  connectionId    String
  connection      CMSConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date            DateTime         @db.Date

  // Google Analytics metrics
  pageviews       Int              @default(0)
  uniqueVisitors  Int              @default(0)
  avgSessionDuration Int           @default(0) // seconds
  bounceRate      Float            @default(0) // 0-1
  topPages        Json             // [{ path, views, avgTime, bounceRate }]
  trafficSources  Json?            // { organic: 45, direct: 30, referral: 25 }

  // Search Console metrics
  searchImpressions    Int?
  searchClicks         Int?
  searchCtr            Float?       // 0-1
  avgSearchPosition    Float?
  topSearchQueries     Json?        // [{ query, impressions, clicks, position }]
  topSearchPages       Json?        // [{ page, impressions, clicks, position }]

  createdAt       DateTime         @default(now())

  @@unique([connectionId, date])
  @@index([connectionId, date])
}
